<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“æ³¨å†œåœº - ä½œç‰©ç®¡ç†</title>
    <script src="common.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-seedling"></i> ä½œç‰©ç®¡ç†</h1>
                    <p class="subtitle">é€‰æ‹©ä½ çš„ä¸“å±ä½œç‰©</p>
                </div>
                <div>
                    <button class="btn btn-primary btn-small" onclick="window.location.href='main.html'">
                        <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
        </header>

        <div class="card">
            <h2 class="card-title"><i class="fas fa-hand-pointer"></i> é€‰æ‹©ä½œç‰©</h2>
            <p style="color: var(--gray); margin-bottom: 20px;">
                ä¸€æ¬¡åªèƒ½ç§æ¤ä¸€ç§ä½œç‰©ï¼Œé€‰æ‹©åéœ€è¦æ¯å¤©æ‰“å¡ä¹ æƒ¯æ¥ä¿ƒè¿›ç”Ÿé•¿
            </p>
            
            <div id="cropsList" class="grid grid-3">
                <!-- ä½œç‰©åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div style="text-align: center; padding: 20px; color: var(--gray);">
                    <i class="fas fa-seedling" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- å½“å‰ä½œç‰©çŠ¶æ€ -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> å½“å‰ä½œç‰©çŠ¶æ€</h2>
                <div id="currentCropStatus">
                    <!-- å½“å‰ä½œç‰©çŠ¶æ€å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- ä¹ æƒ¯ç®¡ç† -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-tasks"></i> ä¹ æƒ¯ç®¡ç†</h2>
                <div id="habitsManagement">
                    <!-- ä¹ æƒ¯ç®¡ç†å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="addNewHabit()" id="addHabitBtn">
                        <i class="fas fa-plus"></i> æ·»åŠ æ–°ä¹ æƒ¯
                    </button>
                    <div style="color: var(--gray); font-size: 0.9rem; margin-top: 10px;">
                        å½“å‰ä¹ æƒ¯ä½ï¼š<span id="currentHabitCount">0</span>/<span id="maxHabits">3</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // åŠ¨æ€è·å–åç«¯åœ°å€
        function getApiBase() {
            // ä¼˜å…ˆä½¿ç”¨å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœº
            const currentUrl = window.location.origin;
            
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼Œä½¿ç”¨é»˜è®¤localhost
            if (currentUrl === 'file://' || currentUrl.startsWith('file://')) {
                return 'http://localhost:3000/api';
            }
            
            // å¦åˆ™ä½¿ç”¨å½“å‰åŸŸå
            return `${currentUrl}/api`;
        }

        let API_BASE = getApiBase();
        console.log('APIåœ°å€:', API_BASE);

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        const networkStatus = document.createElement('div');
        networkStatus.className = 'network-status';
        document.body.appendChild(networkStatus);

        // æ£€æŸ¥ç½‘ç»œè¿æ¥
        function checkNetworkStatus() {
            if (navigator.onLine) {
                networkStatus.textContent = 'åœ¨çº¿';
                networkStatus.className = 'network-status online';
                
                // éšè—ç½‘ç»œçŠ¶æ€æç¤º
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 2000);
            } else {
                networkStatus.textContent = 'ç¦»çº¿ - æ£€æŸ¥ç½‘ç»œè¿æ¥';
                networkStatus.className = 'network-status offline';
            }
        }

        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);

        // åˆå§‹æ£€æŸ¥
        checkNetworkStatus();

        // ä¿®æ”¹æ‰€æœ‰fetchè¯·æ±‚ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok && response.status !== 401) {
                    showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                }
                
                return response;
            } catch (error) {
                console.error('ç½‘ç»œè¯·æ±‚é”™è¯¯:', error);
                
                // æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
                let errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š<br>
                                1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (${API_BASE.replace('/api', '')})<br>
                                2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                                3. é˜²ç«å¢™è®¾ç½®`;
                } else if (error.message.includes('NetworkError')) {
                    errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                }
                
                showNotification(errorMsg, 'error');
                throw error;
            }
        };
        // const API_BASE = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('authToken');
        let userData = null;
        let cropsData = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!authToken) {
            window.location.href = 'index.html';
        }

        // åŠ è½½é¡µé¢æ•°æ®
        async function loadPageData() {
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const userResponse = await fetch(`${API_BASE}/user-data`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const userResult = await userResponse.json();
                if (!userResult.success) {
                    throw new Error(userResult.error || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                }
                
                userData = userResult.data;
                
                // è·å–ä½œç‰©æ•°æ®
                const cropsResponse = await fetch(`${API_BASE}/crops`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const cropsResult = await cropsResponse.json();
                if (cropsResult.success) {
                    cropsData = cropsResult.crops;
                }
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                renderCropsList();
                renderCurrentCropStatus();
                renderHabitsManagement();
                
            } catch (error) {
                console.error('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            }
        }

        // æ¸²æŸ“ä½œç‰©åˆ—è¡¨
        function renderCropsList() {
            const container = document.getElementById('cropsList');
            if (!cropsData) {
                container.innerHTML = '<p style="color: var(--danger);">ä½œç‰©æ•°æ®åŠ è½½å¤±è´¥</p>';
                return;
            }
            
            const currentCrop = userData.crops?.[0];
            const currentCropId = currentCrop && !currentCrop.harvested ? currentCrop.id : null;
            
            container.innerHTML = cropsData.map(crop => {
                const isCurrentCrop = crop.id === currentCropId;
                const canSelect = !currentCropId || isCurrentCrop;
                
                return `
                    <div class="crop-option ${isCurrentCrop ? 'selected' : ''} ${!canSelect ? 'disabled' : ''}" 
                         onclick="${canSelect ? `selectCrop('${crop.id}')` : ''}">
                        <div class="crop-icon" style="font-size: 3rem; margin-bottom: 10px;">${crop.icon}</div>
                        <h3>${crop.name}</h3>
                        <p style="color: var(--gray); font-size: 0.9rem; margin: 10px 0;">${crop.description}</p>
                        <div style="background: ${crop.color}20; padding: 8px; border-radius: var(--radius-sm);">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                                <span><i class="fas fa-clock"></i> ${crop.growthTime}å¤©</span>
                                <span><i class="fas fa-box"></i> ${crop.harvestAmount}ä¸ª</span>
                            </div>
                        </div>
                        ${isCurrentCrop ? 
                            '<div style="margin-top: 10px; color: var(--success); font-weight: bold;">ç§æ¤ä¸­</div>' : 
                            canSelect ? 
                            '<div style="margin-top: 10px; color: var(--primary); font-weight: bold;">ç‚¹å‡»é€‰æ‹©</div>' :
                            '<div style="margin-top: 10px; color: var(--gray); font-size: 0.9rem;">å·²æœ‰ä½œç‰©ç§æ¤ä¸­</div>'
                        }
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“å½“å‰ä½œç‰©çŠ¶æ€
        function renderCurrentCropStatus() {
            const container = document.getElementById('currentCropStatus');
            const currentCrop = userData.crops?.[0];
            
            if (!currentCrop || currentCrop.harvested) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div class="crop-icon" style="font-size: 3rem; color: var(--gray);">ğŸŒ±</div>
                        <h3 style="margin: 15px 0;">å½“å‰æ²¡æœ‰ä½œç‰©åœ¨ç§æ¤</h3>
                        <p style="color: var(--gray);">ä»ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªä½œç‰©å¼€å§‹ç§æ¤å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            const cropInfo = cropsData?.find(c => c.id === currentCrop.id);
            if (!cropInfo) {
                container.innerHTML = `<p style="color: var(--danger);">ä½œç‰©æ•°æ®åŠ è½½å¤±è´¥</p>`;
                return;
            }
            
            const progressPercent = (currentCrop.currentGrowth / cropInfo.growthTime) * 100;
            const remainingDays = Math.max(0, cropInfo.growthTime - currentCrop.currentGrowth);
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div class="crop-icon" style="font-size: 4rem;">${cropInfo.icon}</div>
                    <h3 style="margin: 10px 0;">${cropInfo.name}</h3>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ç”Ÿé•¿è¿›åº¦</span>
                            <span>${currentCrop.currentGrowth}/${cropInfo.growthTime}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    
                    <div style="background: var(--light); padding: 15px; border-radius: var(--radius-md); margin: 20px 0;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--gray);">å¼€å§‹æ—¶é—´</div>
                                <div style="font-size: 1rem;">${new Date(currentCrop.plantedAt).toLocaleDateString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--gray);">è¿˜éœ€ç…§æ–™</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">${remainingDays}æ¬¡</div>
                            </div>
                        </div>
                    </div>
                    
                    ${currentCrop.currentGrowth >= cropInfo.growthTime ? 
                        `<div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="harvestCrop()">
                                <i class="fas fa-hand-holding"></i> æ”¶è·ä½œç‰©
                            </button>
                            <p style="color: var(--gray); font-size: 0.9rem; margin-top: 10px;">æ”¶è·å¯è·å¾—${cropInfo.harvestAmount}ä¸ª${cropInfo.name}</p>
                        </div>` : 
                        `<p style="color: var(--gray); font-size: 0.9rem;">
                            æ¯å¤©å®Œæˆä¹ æƒ¯æ‰“å¡å¯ä»¥ä¿ƒè¿›ä½œç‰©ç”Ÿé•¿
                        </p>`
                    }
                </div>
            `;
        }

        // æ¸²æŸ“ä¹ æƒ¯ç®¡ç†
        function renderHabitsManagement() {
            const container = document.getElementById('habitsManagement');
            const habits = userData.habits || [];
            
            document.getElementById('currentHabitCount').textContent = habits.length;
            document.getElementById('maxHabits').textContent = userData.maxHabits || 3;
            
            if (habits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <i class="fas fa-tasks" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                        <p>è¿˜æ²¡æœ‰ä»»ä½•ä¹ æƒ¯</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            habits.forEach(habit => {
                const today = new Date().toDateString();
                const lastCompletedDate = habit.lastCompleted ? new Date(habit.lastCompleted).toDateString() : null;
                const canCheckin = lastCompletedDate !== today;
                
                html += `
                    <div class="habit-item" style="margin-bottom: 10px;">
                        <div class="habit-info">
                            <h4>${habit.name}</h4>
                            <div class="habit-stats">
                                <span><i class="fas fa-fire"></i> ${habit.streak || 0}å¤©</span>
                                <span><i class="fas fa-check-circle"></i> ${habit.totalCompletions || 0}æ¬¡</span>
                                ${lastCompletedDate ? 
                                    `<span><i class="fas fa-calendar"></i> ${lastCompletedDate === today ? 'ä»Šå¤©' : 'å·²æ‰“å¡'}</span>` : 
                                    '<span><i class="fas fa-calendar-times"></i> æœªæ‰“å¡</span>'
                                }
                            </div>
                        </div>
                        <div class="habit-actions">
                            <button class="btn btn-success btn-small" onclick="checkinHabit('${habit.id}')" ${!canCheckin ? 'disabled' : ''}>
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteHabit('${habit.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // é€‰æ‹©ä½œç‰©
        async function selectCrop(cropId) {
            const currentCrop = userData.crops?.[0];
            if (currentCrop && !currentCrop.harvested) {
                if (!confirm('å·²æœ‰ä½œç‰©åœ¨ç§æ¤ä¸­ï¼Œç¡®å®šè¦æ›´æ¢ä½œç‰©å—ï¼Ÿå½“å‰ä½œç‰©çš„ç”Ÿé•¿è¿›åº¦å°†ä¼šä¸¢å¤±ã€‚')) {
                    return;
                }
            }
            
            try {
                const response = await fetch(`${API_BASE}/plant-crop`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cropId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä½œç‰©ç§æ¤æˆåŠŸï¼', 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadPageData();
                } else {
                    showNotification(data.error || 'ç§æ¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç§æ¤ä½œç‰©é”™è¯¯:', error);
                showNotification('ç§æ¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ”¶è·ä½œç‰©
        async function harvestCrop() {
            try {
                const response = await fetch(`${API_BASE}/harvest-crop`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`æ”¶è·æˆåŠŸï¼è·å¾—${data.harvestedAmount}ä¸ªä½œç‰©`, 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadPageData();
                } else {
                    showNotification(data.error || 'æ”¶è·å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ”¶è·ä½œç‰©é”™è¯¯:', error);
                showNotification('æ”¶è·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ‰“å¡ä¹ æƒ¯
        async function checkinHabit(habitId) {
            try {
                const response = await fetch(`${API_BASE}/checkin-habit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ habitId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä¹ æƒ¯æ‰“å¡æˆåŠŸï¼', 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadPageData();
                } else {
                    showNotification(data.error || 'æ‰“å¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ‰“å¡é”™è¯¯:', error);
                showNotification('æ‰“å¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ·»åŠ æ–°ä¹ æƒ¯
        async function addNewHabit() {
            const habitName = prompt('è¯·è¾“å…¥æ–°ä¹ æƒ¯çš„åç§°ï¼š');
            if (!habitName || habitName.trim() === '') return;
            
            if ((userData.habits || []).length >= (userData.maxHabits || 3)) {
                showNotification(`å·²è¾¾åˆ°æœ€å¤§ä¹ æƒ¯æ•°é‡é™åˆ¶ï¼ˆ${userData.maxHabits}ä¸ªï¼‰`, 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/add-habit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ habitName: habitName.trim() })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä¹ æƒ¯æ·»åŠ æˆåŠŸï¼', 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadPageData();
                } else {
                    showNotification(data.error || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ ä¹ æƒ¯é”™è¯¯:', error);
                showNotification('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // åˆ é™¤ä¹ æƒ¯
        async function deleteHabit(habitId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿ')) return;
            
            // å‰ç«¯åˆ é™¤ï¼Œåç«¯ä¼šåœ¨ä¸‹æ¬¡ä¿å­˜æ—¶æ›´æ–°
            userData.habits = (userData.habits || []).filter(h => h.id !== habitId);
            
            try {
                const response = await fetch(`${API_BASE}/save-data`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ habits: userData.habits })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä¹ æƒ¯åˆ é™¤æˆåŠŸï¼', 'success');
                    renderHabitsManagement();
                } else {
                    showNotification('åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ä¹ æƒ¯é”™è¯¯:', error);
                showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <div>${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', loadPageData);
    </script>
</body>
</html>