<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“æ³¨å†œåœº - ä½œç‰©ç®¡ç†</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="crops.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1><i class="fas fa-seedling"></i> ä½œç‰©ç®¡ç†</h1>
                    <p class="subtitle">é€‰æ‹©ä½ çš„ä¸“å±ä½œç‰©</p>
                </div>
                <div>
                    <button class="btn btn-primary btn-small" onclick="window.location.href='main.html'">
                        <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
        </header>

        <div class="card">
            <h2 class="card-title"><i class="fas fa-hand-pointer"></i> é€‰æ‹©ä½œç‰©</h2>
            <p class="card-subtitle">
                ä¸€æ¬¡åªèƒ½ç§æ¤ä¸€ç§ä½œç‰©ï¼Œé€‰æ‹©åéœ€è¦æ¯å¤©æ‰“å¡ä¹ æƒ¯æ¥ä¿ƒè¿›ç”Ÿé•¿
            </p>
            
            <div id="cropsList" class="grid grid-3">
                <div class="loading-placeholder">
                    <i class="fas fa-seedling"></i>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-2">
            <!-- å½“å‰ä½œç‰©çŠ¶æ€ -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> å½“å‰ä½œç‰©çŠ¶æ€</h2>
                <div id="currentCropStatus">
                    <div class="loading-placeholder">
                        <i class="fas fa-info-circle"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- ä¹ æƒ¯ç®¡ç† -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-tasks"></i> ä¹ æƒ¯ç®¡ç†</h2>
                <div id="habitsManagement">
                    <div class="loading-placeholder">
                        <i class="fas fa-tasks"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                
                <div class="habits-footer">
                    <button class="btn btn-primary" onclick="addNewHabit()" id="addHabitBtn">
                        <i class="fas fa-plus"></i> æ·»åŠ æ–°ä¹ æƒ¯
                    </button>
                    <div class="habits-counter">
                        å½“å‰ä¹ æƒ¯ä½ï¼š<span id="currentHabitCount">0</span>/<span id="maxHabits">3</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notificationContainer"></div>
    
    <!-- å¼¹çª—å®¹å™¨ -->
    <div id="modalContainer"></div>

    <script>
        // åŠ¨æ€è·å–åç«¯åœ°å€
        function getApiBase() {
            const currentUrl = window.location.origin;
            
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼Œä½¿ç”¨é»˜è®¤localhost
            if (currentUrl === 'file://' || currentUrl.startsWith('file://')) {
                return 'http://localhost:3000/api';
            }
            
            // å¦åˆ™ä½¿ç”¨å½“å‰åŸŸå
            return `${currentUrl}/api`;
        }

        let API_BASE = getApiBase();
        console.log('APIåœ°å€:', API_BASE);

        // å…¨å±€å˜é‡
        let authToken = localStorage.getItem('authToken');
        let userData = null;
        let cropsData = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!authToken) {
            window.location.href = 'index.html';
        }

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        const networkStatus = document.createElement('div');
        networkStatus.className = 'network-status';
        document.body.appendChild(networkStatus);

        // æ£€æŸ¥ç½‘ç»œè¿æ¥
        function checkNetworkStatus() {
            if (navigator.onLine) {
                networkStatus.textContent = 'åœ¨çº¿';
                networkStatus.className = 'network-status online';
                
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 2000);
            } else {
                networkStatus.textContent = 'ç¦»çº¿ - æ£€æŸ¥ç½‘ç»œè¿æ¥';
                networkStatus.className = 'network-status offline';
            }
        }

        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);

        // åˆå§‹æ£€æŸ¥
        checkNetworkStatus();

        // ä¿®æ”¹æ‰€æœ‰fetchè¯·æ±‚ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                
                if (!response.ok && response.status !== 401) {
                    showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                }
                
                return response;
            } catch (error) {
                console.error('ç½‘ç»œè¯·æ±‚é”™è¯¯:', error);
                
                let errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š<br>
                                1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (${API_BASE.replace('/api', '')})<br>
                                2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                                3. é˜²ç«å¢™è®¾ç½®`;
                } else if (error.message.includes('NetworkError')) {
                    errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                }
                
                showNotification(errorMsg, 'error');
                throw error;
            }
        };

        // å¼¹çª—ç›¸å…³å‡½æ•°
        function showModal(options) {
            const {
                title,
                content,
                type = 'info',
                buttons = [],
                onClose = null,
                size = 'md'
            } = options;
            
            const modalId = 'modal-' + Date.now();
            const modalSizes = {
                sm: 'max-width: 400px',
                md: 'max-width: 500px',
                lg: 'max-width: 600px'
            };
            
            const modalHTML = `
                <div class="modal-overlay" id="${modalId}">
                    <div class="modal" style="${modalSizes[size]}">
                        <div class="modal-header">
                            <h3>${title}</h3>
                            <button class="modal-close" onclick="closeModal('${modalId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        ${buttons.length > 0 ? `
                            <div class="modal-footer">
                                ${buttons.map(btn => `
                                    <button 
                                        class="btn ${btn.class || 'btn-secondary'}" 
                                        onclick="${btn.onclick}"
                                        ${btn.disabled ? 'disabled' : ''}>
                                        ${btn.text}
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML += modalHTML;
            
            // æ˜¾ç¤ºå¼¹çª—
            setTimeout(() => {
                const modal = document.getElementById(modalId);
                modal.classList.add('show');
                
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeModal(modalId);
                    }
                });
                
                // ESCé”®å…³é—­
                const escHandler = function(e) {
                    if (e.key === 'Escape') {
                        closeModal(modalId);
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);
            }, 10);
            
            return modalId;
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        function showConfirm(options) {
            const {
                title,
                message,
                type = 'warning',
                confirmText = 'ç¡®è®¤',
                cancelText = 'å–æ¶ˆ',
                onConfirm = () => {},
                onCancel = () => {},
                icon = null
            } = options;
            
            const icons = {
                warning: 'fa-exclamation-triangle',
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                info: 'fa-info-circle'
            };
            
            const iconType = icon || (icons[type] ? type : 'info');
            const iconClass = icons[iconType] || icons.info;
            
            const modalId = showModal({
                title,
                content: `
                    <div class="confirm-modal">
                        <div class="modal-icon ${iconType}">
                            <i class="fas ${iconClass}"></i>
                        </div>
                        ${message ? `<div class="modal-message">${message}</div>` : ''}
                    </div>
                `,
                type,
                buttons: [
                    {
                        text: cancelText,
                        class: 'btn-secondary',
                        onclick: `closeModal('${modalId}'); (${onCancel.toString()})()`
                    },
                    {
                        text: confirmText,
                        class: `btn-${type === 'warning' || type === 'error' ? 'danger' : type}`,
                        onclick: `closeModal('${modalId}'); (${onConfirm.toString()})()`
                    }
                ]
            });
            
            return modalId;
        }

        // æ˜¾ç¤ºè¾“å…¥å¼¹çª—
        function showInputModal(options) {
            const {
                title,
                placeholder = '',
                defaultValue = '',
                inputType = 'text',
                rows = 3,
                confirmText = 'ç¡®è®¤',
                cancelText = 'å–æ¶ˆ',
                onConfirm = () => {},
                onCancel = () => {}
            } = options;
            
            const inputId = 'input-' + Date.now();
            const isTextarea = inputType === 'textarea';
            const inputElement = isTextarea 
                ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="${rows}">${defaultValue}</textarea>`
                : `<input type="${inputType}" id="${inputId}" placeholder="${placeholder}" value="${defaultValue}">`;
            
            const modalId = showModal({
                title,
                content: `
                    <div class="input-modal">
                        <div class="input-group">
                            ${inputElement}
                        </div>
                    </div>
                `,
                buttons: [
                    {
                        text: cancelText,
                        class: 'btn-secondary',
                        onclick: `closeModal('${modalId}'); (${onCancel.toString()})()`
                    },
                    {
                        text: confirmText,
                        class: 'btn-primary',
                        onclick: `(() => {
                            const value = document.getElementById('${inputId}').value.trim();
                            closeModal('${modalId}');
                            (${onConfirm.toString()})(value);
                        })()`
                    }
                ]
            });
            
            // è‡ªåŠ¨èšç„¦
            setTimeout(() => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.focus();
                    if (!isTextarea) {
                        input.select();
                    }
                }
            }, 100);
            
            return modalId;
        }

        // æ˜¾ç¤ºä½œç‰©è¯¦æƒ…å¼¹çª—
        function showCropDetail(cropId) {
            const crop = cropsData?.find(c => c.id === cropId);
            if (!crop) return;
            
            // ç”Ÿæˆéš¾åº¦æ˜Ÿæ˜Ÿ
            const difficultyStars = 'â˜…'.repeat(crop.difficulty) + 'â˜†'.repeat(3 - crop.difficulty);
            
            const modalId = showModal({
                title: 'ä½œç‰©è¯¦æƒ…',
                content: `
                    <div class="crop-detail-modal">
                        <div class="crop-header">
                            <div class="crop-icon" style="color: ${crop.color}">${crop.icon}</div>
                            <h2 class="crop-name">${crop.name}</h2>
                            <p class="crop-description">${crop.description}</p>
                            <div class="difficulty-badge">
                                <span class="star">${difficultyStars}</span>
                                <span>éš¾åº¦ï¼š${crop.difficulty}æ˜Ÿ</span>
                            </div>
                        </div>
                        
                        <div class="crop-stats">
                            <div class="stat-item">
                                <div class="stat-label"><i class="fas fa-clock"></i> ç”Ÿé•¿å‘¨æœŸ</div>
                                <div class="stat-value">${crop.growthTime}å¤©</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label"><i class="fas fa-box"></i> æ”¶è·æ•°é‡</div>
                                <div class="stat-value">${crop.harvestAmount}ä¸ª</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label"><i class="fas fa-sun"></i> å…‰ç…§éœ€æ±‚</div>
                                <div class="stat-value">${crop.requirements?.light || 'ä¸­ç­‰'}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label"><i class="fas fa-tint"></i> æ°´åˆ†éœ€æ±‚</div>
                                <div class="stat-value">${crop.requirements?.water || 'ä¸­ç­‰'}</div>
                            </div>
                        </div>
                        
                        ${crop.tips ? `
                            <div class="clue-box">
                                <div class="clue-title">
                                    <i class="fas fa-lightbulb"></i>
                                    <span>ç§æ¤å°è´´å£«</span>
                                </div>
                                <p>${crop.tips}</p>
                            </div>
                        ` : ''}
                        
                        <div class="crop-instructions">
                            <h4><i class="fas fa-seedling"></i> ç§æ¤è¯´æ˜</h4>
                            <p>
                                æ¯å¤©å®Œæˆè‡³å°‘ä¸€ä¸ªä¹ æƒ¯æ‰“å¡æ¥ä¿ƒè¿›ä½œç‰©ç”Ÿé•¿ã€‚
                                å½“ç”Ÿé•¿è¿›åº¦è¾¾åˆ°${crop.growthTime}å¤©åå³å¯æ”¶è·ã€‚
                                æ”¶è·åä¼šè·å¾—${crop.harvestAmount}ä¸ª${crop.name}ã€‚
                            </p>
                            ${crop.seasons ? `
                                <div style="margin-top: 10px;">
                                    <strong>é€‚åˆå­£èŠ‚ï¼š</strong>${crop.seasons.join('ã€')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `,
                size: 'md'
            });
            
            return modalId;
        }

        // åŠ è½½é¡µé¢æ•°æ®
        async function loadPageData() {
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const userResponse = await fetch(`${API_BASE}/user-data`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const userResult = await userResponse.json();
                if (!userResult.success) {
                    throw new Error(userResult.error || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                }
                
                userData = userResult.data;
                
                // è·å–ä½œç‰©æ•°æ®
                const cropsResponse = await fetch(`${API_BASE}/crops`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const cropsResult = await cropsResponse.json();
                if (cropsResult.success) {
                    cropsData = cropsResult.crops;
                }
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                renderCropsList();
                renderCurrentCropStatus();
                renderHabitsManagement();
                
            } catch (error) {
                console.error('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            }
        }

        // æ¸²æŸ“ä½œç‰©åˆ—è¡¨
        function renderCropsList() {
            const container = document.getElementById('cropsList');
            if (!cropsData) {
                container.innerHTML = '<div class="error-message">ä½œç‰©æ•°æ®åŠ è½½å¤±è´¥</div>';
                return;
            }
            
            const currentCrop = userData.crops?.[0];
            const currentCropId = currentCrop && !currentCrop.harvested ? currentCrop.id : null;
            
            // æŒ‰éš¾åº¦æ’åºï¼Œç®€å•çš„ä½œç‰©æ’å‰é¢
            const sortedCrops = [...cropsData].sort((a, b) => a.difficulty - b.difficulty);
            
            container.innerHTML = sortedCrops.map(crop => {
                const isCurrentCrop = crop.id === currentCropId;
                const canSelect = !currentCropId || isCurrentCrop;
                
                // ç”Ÿæˆéš¾åº¦æ˜Ÿæ˜Ÿ
                const difficultyStars = 'â˜…'.repeat(crop.difficulty) + 'â˜†'.repeat(3 - crop.difficulty);
                const difficultyText = ['ç®€å•', 'ä¸­ç­‰', 'å›°éš¾'][crop.difficulty - 1];
                
                // ç”Ÿæˆå­£èŠ‚æ ‡ç­¾
                const seasonsHtml = crop.seasons ? 
                    `<div class="seasons-tags">
                        ${crop.seasons.map(season => `<span class="season-tag">${season}</span>`).join('')}
                    </div>` : '';
                
                // ç‰¹æ®Šä½œç‰©æ ‡è®°
                const specialBadge = crop.special ? 
                    '<div class="special-badge"><i class="fas fa-star"></i> ç‰¹æ®Š</div>' : '';
                
                return `
                    <div class="crop-option ${isCurrentCrop ? 'selected' : ''} ${!canSelect ? 'disabled' : ''}">
                        ${specialBadge}
                        <div class="crop-icon" style="color: ${crop.color}">${crop.icon}</div>
                        <h3>${crop.name}</h3>
                        
                        <div class="difficulty-indicator">
                            <span class="difficulty-stars">${difficultyStars}</span>
                            <span class="difficulty-text">${difficultyText}</span>
                        </div>
                        
                        ${seasonsHtml}
                        
                        <p class="crop-description-short">${crop.description}</p>
                        
                        <div class="crop-stats-short" style="background: ${crop.color}20;">
                            <div class="stat-row">
                                <span><i class="fas fa-clock"></i> ${crop.growthTime}å¤©</span>
                                <span><i class="fas fa-box"></i> ${crop.harvestAmount}ä¸ª</span>
                            </div>
                            ${crop.requirements ? `
                                <div class="stat-row">
                                    <span><i class="fas fa-sun"></i> ${crop.requirements.light}</span>
                                    <span><i class="fas fa-tint"></i> ${crop.requirements.water}</span>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="crop-value" style="color: ${crop.color};">
                            <i class="fas fa-gem"></i> ä»·å€¼ï¼š${crop.value || 1}
                        </div>
                        
                        <div class="crop-actions">
                            ${canSelect ? 
                                `<button class="btn btn-primary btn-small" onclick="selectCrop('${crop.id}')">
                                    ${isCurrentCrop ? 
                                        '<i class="fas fa-check-circle"></i> ç§æ¤ä¸­' : 
                                        '<i class="fas fa-seedling"></i> ç«‹å³ç§æ¤'
                                    }
                                </button>` : 
                                '<div class="planting-hint">å·²æœ‰ä½œç‰©ç§æ¤ä¸­</div>'
                            }
                            <button class="btn btn-secondary btn-small" onclick="showCropDetail('${crop.id}')">
                                <i class="fas fa-info-circle"></i> è¯¦æƒ…
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“å½“å‰ä½œç‰©çŠ¶æ€
        function renderCurrentCropStatus() {
            const container = document.getElementById('currentCropStatus');
            const currentCrop = userData.crops?.[0];
            
            if (!currentCrop || currentCrop.harvested) {
                container.innerHTML = `
                    <div class="no-crop">
                        <div class="crop-icon">ğŸŒ±</div>
                        <h3>å½“å‰æ²¡æœ‰ä½œç‰©åœ¨ç§æ¤</h3>
                        <p>ä»ä¸Šæ–¹é€‰æ‹©ä¸€ä¸ªä½œç‰©å¼€å§‹ç§æ¤å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            const cropInfo = cropsData?.find(c => c.id === currentCrop.id);
            if (!cropInfo) {
                container.innerHTML = '<div class="error-message">ä½œç‰©æ•°æ®åŠ è½½å¤±è´¥</div>';
                return;
            }
            
            const progressPercent = (currentCrop.currentGrowth / cropInfo.growthTime) * 100;
            const remainingDays = Math.max(0, cropInfo.growthTime - currentCrop.currentGrowth);
            
            container.innerHTML = `
                <div class="current-crop">
                    <div class="crop-icon-large" style="color: ${cropInfo.color}">${cropInfo.icon}</div>
                    <h3>${cropInfo.name}</h3>
                    
                    <div class="progress-section">
                        <div class="progress-header">
                            <span>ç”Ÿé•¿è¿›åº¦</span>
                            <span>${currentCrop.currentGrowth}/${cropInfo.growthTime}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    
                    <div class="crop-info-grid">
                        <div class="info-item">
                            <div class="info-label">å¼€å§‹æ—¶é—´</div>
                            <div class="info-value">${new Date(currentCrop.plantedAt).toLocaleDateString()}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">è¿˜éœ€ç…§æ–™</div>
                            <div class="info-value highlight">${remainingDays}æ¬¡</div>
                        </div>
                    </div>
                    
                    <div class="crop-actions-group">
                        ${currentCrop.currentGrowth >= cropInfo.growthTime ? 
                            `<button class="btn btn-success" onclick="harvestCrop()">
                                <i class="fas fa-hand-holding"></i> æ”¶è·ä½œç‰©
                            </button>` : 
                            `<button class="btn btn-primary" onclick="showCropDetail('${currentCrop.id}')">
                                <i class="fas fa-info-circle"></i> æŸ¥çœ‹è¯¦æƒ…
                            </button>`
                        }
                        <button class="btn btn-danger" onclick="abandonCrop()">
                            <i class="fas fa-trash"></i> æ”¾å¼ƒä½œç‰©
                        </button>
                    </div>
                    
                    ${currentCrop.currentGrowth >= cropInfo.growthTime ? 
                        `<p class="crop-hint">
                            æ”¶è·å¯è·å¾—${cropInfo.harvestAmount}ä¸ª${cropInfo.name}
                        </p>` : 
                        `<p class="crop-hint">
                            æ¯å¤©å®Œæˆä¹ æƒ¯æ‰“å¡å¯ä»¥ä¿ƒè¿›ä½œç‰©ç”Ÿé•¿
                        </p>`
                    }
                </div>
            `;
        }

        // æ¸²æŸ“ä¹ æƒ¯ç®¡ç†
        function renderHabitsManagement() {
            const container = document.getElementById('habitsManagement');
            const habits = userData.habits || [];
            
            document.getElementById('currentHabitCount').textContent = habits.length;
            document.getElementById('maxHabits').textContent = userData.maxHabits || 3;
            
            if (habits.length === 0) {
                container.innerHTML = `
                    <div class="no-habits">
                        <i class="fas fa-tasks"></i>
                        <p>è¿˜æ²¡æœ‰ä»»ä½•ä¹ æƒ¯</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            habits.forEach(habit => {
                const today = new Date().toDateString();
                const lastCompletedDate = habit.lastCompleted ? new Date(habit.lastCompleted).toDateString() : null;
                const canCheckin = lastCompletedDate !== today;
                
                html += `
                    <div class="habit-item">
                        <div class="habit-info">
                            <h4>${habit.name}</h4>
                            <div class="habit-stats">
                                <span><i class="fas fa-fire"></i> ${habit.streak || 0}å¤©</span>
                                <span><i class="fas fa-check-circle"></i> ${habit.totalCompletions || 0}æ¬¡</span>
                                ${lastCompletedDate ? 
                                    `<span><i class="fas fa-calendar"></i> ${lastCompletedDate === today ? 'ä»Šå¤©' : 'å·²æ‰“å¡'}</span>` : 
                                    '<span><i class="fas fa-calendar-times"></i> æœªæ‰“å¡</span>'
                                }
                            </div>
                        </div>
                        <div class="habit-actions">
                            <button class="btn btn-success btn-small" onclick="checkinHabit('${habit.id}')" ${!canCheckin ? 'disabled' : ''}>
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-small" onclick="deleteHabit('${habit.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // é€‰æ‹©ä½œç‰©
        async function selectCrop(cropId) {
            const currentCrop = userData.crops?.[0];
            
            if (currentCrop && !currentCrop.harvested) {
                showConfirm({
                    title: 'æ›´æ¢ä½œç‰©',
                    message: 'å·²æœ‰ä½œç‰©åœ¨ç§æ¤ä¸­ï¼Œæ›´æ¢ä½œç‰©ä¼šå¯¼è‡´å½“å‰ä½œç‰©ç”Ÿé•¿è¿›åº¦ä¸¢å¤±ã€‚æ˜¯å¦ç»§ç»­ï¼Ÿ',
                    type: 'warning',
                    confirmText: 'ç¡®è®¤æ›´æ¢',
                    cancelText: 'å–æ¶ˆ',
                    onConfirm: () => {
                        plantCrop(cropId);
                    },
                    onCancel: () => {
                        console.log('å–æ¶ˆæ›´æ¢ä½œç‰©');
                    }
                });
            } else {
                plantCrop(cropId);
            }
        }

        // ç‹¬ç«‹çš„ç§æ¤ä½œç‰©å‡½æ•°
        async function plantCrop(cropId) {
            try {
                const response = await fetch(`${API_BASE}/plant-crop`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cropId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä½œç‰©ç§æ¤æˆåŠŸï¼', 'success');
                    await loadPageData();
                } else {
                    showNotification(data.error || 'ç§æ¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç§æ¤ä½œç‰©é”™è¯¯:', error);
                showNotification('ç§æ¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ”¶è·ä½œç‰©
        async function harvestCrop() {
            try {
                const response = await fetch(`${API_BASE}/harvest-crop`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`æ”¶è·æˆåŠŸï¼è·å¾—${data.harvestedAmount}ä¸ªä½œç‰©`, 'success');
                    await loadPageData();
                } else {
                    showNotification(data.error || 'æ”¶è·å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ”¶è·ä½œç‰©é”™è¯¯:', error);
                showNotification('æ”¶è·å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // ä½œç‰©æ”¾å¼ƒåŠŸèƒ½
        async function abandonCrop() {
            const currentCrop = userData.crops?.[0];
            if (!currentCrop || currentCrop.harvested) {
                showNotification('å½“å‰æ²¡æœ‰ä½œç‰©åœ¨ç§æ¤', 'info');
                return;
            }
            
            const cropInfo = cropsData?.find(c => c.id === currentCrop.id);
            
            showConfirm({
                title: 'æ”¾å¼ƒä½œç‰©',
                message: cropInfo ? 
                    `ç¡®å®šè¦æ”¾å¼ƒæ­£åœ¨ç”Ÿé•¿çš„${cropInfo.name}å—ï¼Ÿ<br><br>
                    <small style="color: var(--gray);">
                    å½“å‰ç”Ÿé•¿è¿›åº¦ï¼š${currentCrop.currentGrowth}/${cropInfo.growthTime}<br>
                    æ”¾å¼ƒåå°†æ— æ³•æ¢å¤ï¼Œéœ€è¦é‡æ–°ç§æ¤ã€‚
                    </small>` :
                    'ç¡®å®šè¦æ”¾å¼ƒå½“å‰ä½œç‰©å—ï¼Ÿ',
                type: 'error',
                icon: 'warning',
                confirmText: 'ç¡®è®¤æ”¾å¼ƒ',
                cancelText: 'ç»§ç»­ç§æ¤',
                onConfirm: async () => {
                    try {
                        const response = await fetch(`${API_BASE}/abandon-crop`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showNotification('ä½œç‰©å·²æ”¾å¼ƒ', 'success');
                            await loadPageData();
                        } else {
                            showNotification(data.error || 'æ”¾å¼ƒå¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('æ”¾å¼ƒä½œç‰©é”™è¯¯:', error);
                        showNotification('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                    }
                }
            });
        }

        // æ‰“å¡ä¹ æƒ¯
        async function checkinHabit(habitId) {
            try {
                const response = await fetch(`${API_BASE}/checkin-habit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ habitId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä¹ æƒ¯æ‰“å¡æˆåŠŸï¼', 'success');
                    await loadPageData();
                } else {
                    showNotification(data.error || 'æ‰“å¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ‰“å¡é”™è¯¯:', error);
                showNotification('æ‰“å¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ·»åŠ æ–°ä¹ æƒ¯
        async function addNewHabit() {
            const habits = userData.habits || [];
            const maxHabits = userData.maxHabits || 3;
            
            if (habits.length >= maxHabits) {
                showConfirm({
                    title: 'ä¹ æƒ¯ä½å·²æ»¡',
                    message: `å·²è¾¾åˆ°æœ€å¤§ä¹ æƒ¯æ•°é‡é™åˆ¶ï¼ˆ${maxHabits}ä¸ªï¼‰ï¼Œæ— æ³•æ·»åŠ æ–°ä¹ æƒ¯ã€‚`,
                    type: 'info',
                    confirmText: 'çŸ¥é“äº†',
                    onConfirm: () => {}
                });
                return;
            }
            
            showInputModal({
                title: 'æ·»åŠ æ–°ä¹ æƒ¯',
                placeholder: 'è¯·è¾“å…¥ä¹ æƒ¯åç§°ï¼ˆå¦‚ï¼šæ—©ç¡ã€é˜…è¯»ç­‰ï¼‰',
                confirmText: 'æ·»åŠ ',
                cancelText: 'å–æ¶ˆ',
                onConfirm: async (habitName) => {
                    if (!habitName || habitName.trim() === '') {
                        showNotification('ä¹ æƒ¯åç§°ä¸èƒ½ä¸ºç©º', 'error');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`${API_BASE}/add-habit`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ habitName: habitName.trim() })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showNotification('ä¹ æƒ¯æ·»åŠ æˆåŠŸï¼', 'success');
                            await loadPageData();
                        } else {
                            showNotification(data.error || 'æ·»åŠ å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('æ·»åŠ ä¹ æƒ¯é”™è¯¯:', error);
                        showNotification('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                    }
                },
                onCancel: () => {
                    console.log('å–æ¶ˆæ·»åŠ ä¹ æƒ¯');
                }
            });
        }

        // åˆ é™¤ä¹ æƒ¯
        async function deleteHabit(habitId) {
            showConfirm({
                title: 'åˆ é™¤ä¹ æƒ¯',
                message: 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¹ æƒ¯å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚',
                type: 'warning',
                confirmText: 'ç¡®è®¤åˆ é™¤',
                cancelText: 'å–æ¶ˆ',
                onConfirm: async () => {
                    // å‰ç«¯åˆ é™¤
                    userData.habits = (userData.habits || []).filter(h => h.id !== habitId);
                    
                    try {
                        const response = await fetch(`${API_BASE}/save-data`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${authToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ habits: userData.habits })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showNotification('ä¹ æƒ¯åˆ é™¤æˆåŠŸï¼', 'success');
                            renderHabitsManagement();
                        } else {
                            showNotification('åˆ é™¤å¤±è´¥', 'error');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤ä¹ æƒ¯é”™è¯¯:', error);
                        showNotification('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
                    }
                }
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <div>${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', loadPageData);
    </script>
</body>
</html>