<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“æ³¨å†œåœº - ä»“åº“ä¸èœè°±</title>
    <script src="common.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ææ–™é€‰æ‹©å™¨ä¼˜åŒ– */
        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .ingredient-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 12px 8px;
            background: white;
            border: 2px solid var(--light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 90px;
        }
        
        .ingredient-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .ingredient-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(255, 158, 109, 0.1), rgba(255, 158, 109, 0.05));
            box-shadow: 0 0 0 2px rgba(255, 158, 109, 0.2);
        }
        
        .ingredient-option.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .ingredient-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }
        
        .ingredient-name {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .ingredient-count {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: bold;
        }
        
        .ingredient-count.zero {
            color: var(--danger);
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid var(--light);
        }
        
        .modal-title {
            margin: 0;
            font-size: 1.3rem;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* çº¿ç´¢æç¤ºæ ·å¼ */
        .clue-box {
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
            border-left: 4px solid var(--accent);
            padding: 15px;
            border-radius: var(--radius-md);
            margin: 15px 0;
        }
        
        .clue-title {
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .hint-text {
            color: var(--gray);
            font-size: 0.9rem;
            font-style: italic;
            margin-top: 10px;
        }
        
        /* ç ”å‘ç»“æœæ ·å¼ */
        .recipe-reveal {
            text-align: center;
            animation: fadeIn 0.6s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .recipe-icon-large {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: bounce 1s ease infinite alternate;
        }
        
        @keyframes bounce {
            from { transform: scale(0.95); }
            to { transform: scale(1.05); }
        }
        
        /* èœè°±éš¾åº¦æ ‡ç­¾ */
        .difficulty-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: var(--light);
            color: var(--dark);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        
        .difficulty-badge .star {
            color: #FFD700;
        }
        
        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .ingredient-grid {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
                gap: 8px;
            }
            
            .ingredient-option {
                padding: 10px 6px;
                min-height: 80px;
            }
            
            .ingredient-icon {
                font-size: 1.8rem;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
            
            .recipe-item {
                padding: 15px !important;
            }
        }
        
        @media (max-width: 480px) {
            .ingredient-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .ingredient-option {
                min-height: 75px;
            }
            
            .grid.grid-2 {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ */
        .network-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            z-index: 1000;
            display: none;
        }
        
        .network-status.online {
            background: var(--success);
            color: white;
            display: block;
        }
        
        .network-status.offline {
            background: var(--danger);
            color: white;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-scroll"></i> ä»“åº“ä¸èœè°±ç ”å‘</h1>
                    <p class="subtitle">ç®¡ç†ææ–™ï¼Œç ”å‘ç¥ç§˜èœè°±</p>
                </div>
                <div>
                    <button class="btn btn-primary btn-small" onclick="window.location.href='main.html'">
                        <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-2">
            <!-- ææ–™ä»“åº“ -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-warehouse"></i> ææ–™ä»“åº“</h2>
                <p style="color: var(--gray); margin-bottom: 20px;">
                    æ”¶è·çš„ä½œç‰©ä¼šå­˜æ”¾åœ¨è¿™é‡Œï¼Œç”¨äºèœè°±ç ”å‘
                </p>
                
                <div id="storageList" class="grid grid-3">
                    <!-- ä»“åº“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: var(--radius-md);">
                    <h4><i class="fas fa-lightbulb"></i> ææ–™è·å–æŒ‡å—</h4>
                    <ul style="margin-top: 10px; padding-left: 20px; color: var(--gray);">
                        <li>ç§æ¤å¹¶æ”¶è·ä½œç‰©</li>
                        <li>æ¯å¤©æ‰“å¡ä¹ æƒ¯ä¿ƒè¿›ä½œç‰©ç”Ÿé•¿</li>
                        <li>ä½œç‰©æˆç†Ÿåå³å¯æ”¶è·</li>
                        <li>ä¸åŒçš„ä½œç‰©å¯ä»¥ç»„åˆç ”å‘èœè°±</li>
                    </ul>
                </div>
            </div>

            <!-- èœè°±ç ”å‘éƒ¨åˆ† -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-flask"></i> èœè°±ç ”å‘</h2>
                <p style="color: var(--gray); margin-bottom: 20px;">
                    é€šè¿‡çº¿ç´¢æ¢ç´¢ç¥ç§˜èœè°±ï¼Œä½¿ç”¨ä»“åº“ææ–™è¿›è¡Œå°è¯•
                </p>
                
                <div id="recipesList">
                    <!-- èœè°±åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- å¿«é€Ÿæ¢ç´¢åŒºåŸŸ -->
                <div class="card" style="margin-top: 20px; background: #F8F9FA;">
                    <h3 class="card-title"><i class="fas fa-bolt"></i> å¿«é€Ÿæ¢ç´¢</h3>
                    <div id="researchArea">
                        <p style="color: var(--gray); margin-bottom: 15px;">
                            é€‰æ‹©ä¸€ä¸ªæœªè§£é”çš„èœè°±å¼€å§‹ç ”å‘ï¼Œæˆ–è€…ç›´æ¥å°è¯•ææ–™ç»„åˆ
                        </p>
                        
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
                            <button class="btn btn-primary" onclick="startRandomResearch()" style="flex: 1;">
                                <i class="fas fa-dice"></i> æ™ºèƒ½æ¨è
                            </button>
                            <button class="btn btn-outline" onclick="showAllIngredients()" style="flex: 1;">
                                <i class="fas fa-list"></i> æŸ¥çœ‹ææ–™
                            </button>
                        </div>
                        
                        <div id="quickResearchHint" style="background: white; padding: 15px; border-radius: var(--radius-md);">
                            <h4><i class="fas fa-lightbulb"></i> ç ”å‘å°è´´å£«</h4>
                            <ul style="margin-top: 10px; color: var(--gray); padding-left: 20px;">
                                <li>æ ¹æ®åº“å­˜æ•°é‡é€‰æ‹©ç ”å‘ç­–ç•¥</li>
                                <li>å¤±è´¥åä¼šè·å¾—æ–°çš„çº¿ç´¢æç¤º</li>
                                <li>æˆåŠŸç ”å‘å¯è·å¾—é¢å¤–ä¹ æƒ¯ä½</li>
                                <li>åº“å­˜å……è¶³æ—¶ç ”å‘æˆåŠŸç‡æ›´é«˜</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç ”å‘è¿›åº¦ -->
        <div class="card">
            <h2 class="card-title"><i class="fas fa-chart-pie"></i> ç ”å‘è¿›åº¦</h2>
            <div id="researchProgress">
                <!-- ç ”å‘è¿›åº¦å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div style="text-align: center; padding: 20px; color: var(--gray);">
                    <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // åŠ¨æ€è·å–åç«¯åœ°å€
        function getApiBase() {
            const currentUrl = window.location.origin;
            if (currentUrl === 'file://' || currentUrl.startsWith('file://')) {
                return 'http://localhost:3000/api';
            }
            return `${currentUrl}/api`;
        }

        let API_BASE = getApiBase();
        console.log('APIåœ°å€:', API_BASE);

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        const networkStatus = document.createElement('div');
        networkStatus.className = 'network-status';
        document.body.appendChild(networkStatus);

        function checkNetworkStatus() {
            if (navigator.onLine) {
                networkStatus.textContent = 'åœ¨çº¿';
                networkStatus.className = 'network-status online';
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 2000);
            } else {
                networkStatus.textContent = 'ç¦»çº¿ - æ£€æŸ¥ç½‘ç»œè¿æ¥';
                networkStatus.className = 'network-status offline';
            }
        }

        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);
        checkNetworkStatus();

        // ä¿®æ”¹æ‰€æœ‰fetchè¯·æ±‚ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                if (!response.ok && response.status !== 401) {
                    showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                }
                return response;
            } catch (error) {
                console.error('ç½‘ç»œè¯·æ±‚é”™è¯¯:', error);
                let errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š<br>
                                1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (${API_BASE.replace('/api', '')})<br>
                                2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                                3. é˜²ç«å¢™è®¾ç½®`;
                } else if (error.message.includes('NetworkError')) {
                    errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                }
                showNotification(errorMsg, 'error');
                throw error;
            }
        };

        let authToken = localStorage.getItem('authToken');
        let userData = null;
        let cropsData = null;
        let recipesData = null;
        let researchHistory = null;
        let selectedIngredients = [];
        let currentResearchRecipe = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!authToken) {
            window.location.href = 'index.html';
        }

        // åŠ è½½é¡µé¢æ•°æ®
        async function loadPageData() {
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const userResponse = await fetch(`${API_BASE}/user-data`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const userResult = await userResponse.json();
                if (!userResult.success) {
                    throw new Error(userResult.error || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                }
                
                userData = userResult.data;
                
                // è·å–ä½œç‰©æ•°æ®
                const cropsResponse = await fetch(`${API_BASE}/crops`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const cropsResult = await cropsResponse.json();
                if (cropsResult.success) {
                    cropsData = cropsResult.crops;
                }
                
                // è·å–èœè°±æ•°æ®
                const recipesResponse = await fetch(`${API_BASE}/recipes`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const recipesResult = await recipesResponse.json();
                if (recipesResult.success) {
                    recipesData = recipesResult.recipes;
                }
                
                // è·å–ç ”å‘å†å²
                const historyResponse = await fetch(`${API_BASE}/research-history`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const historyResult = await historyResponse.json();
                if (historyResult.success) {
                    researchHistory = historyResult.history;
                }
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                renderStorageList();
                renderRecipesList();
                renderResearchProgress();
                
            } catch (error) {
                console.error('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            }
        }

        // æ¸²æŸ“ä»“åº“åˆ—è¡¨
        function renderStorageList() {
            const container = document.getElementById('storageList');
            const storage = userData.storage || {};
            
            if (!cropsData) return;
            
            // è¿‡æ»¤å‡ºæœ‰åº“å­˜çš„ä½œç‰©
            const items = cropsData
                .map(crop => ({ crop, quantity: storage[crop.id] || 0 }))
                .filter(item => item.quantity > 0);
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>ä»“åº“ç©ºç©ºå¦‚ä¹Ÿ</h3>
                        <p style="margin-top: 10px;">å¿«å»ç§æ¤ä½œç‰©å¹¶æ”¶è·å§ï¼</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="window.location.href='crops.html'">
                            <i class="fas fa-seedling"></i> å‰å¾€ç§æ¤
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="storage-item" style="text-align: center; padding: 15px;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">${item.crop.icon}</div>
                    <h4 style="margin: 10px 0;">${item.crop.name}</h4>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 10px 0;">
                        ${item.quantity}ä¸ª
                    </div>
                    <div style="font-size: 0.9rem; color: var(--gray);">
                        ç”¨äºèœè°±ç ”å‘
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“èœè°±åˆ—è¡¨ï¼ˆä¿®æ”¹ä¸ºä¸æ˜¾ç¤ºå…·ä½“ææ–™ï¼‰
        function renderRecipesList() {
            const container = document.getElementById('recipesList');
            if (!recipesData) {
                container.innerHTML = '<p style="color: var(--danger);">èœè°±æ•°æ®åŠ è½½å¤±è´¥</p>';
                return;
            }
            
            const discoveredRecipes = userData.discoveredRecipes || [];
            
            container.innerHTML = recipesData.map(recipe => {
                const isDiscovered = discoveredRecipes.includes(recipe.id);
                const recipeHistory = researchHistory?.[recipe.id] || {};
                const attempts = recipeHistory.attempts || 0;
                
                return `
                    <div class="recipe-item" style="margin-bottom: 20px; padding: 20px; 
                          background: white; border-radius: var(--radius-md);
                          border: 1px solid ${isDiscovered ? 'var(--success-light)' : 'var(--light)'};
                          ${!isDiscovered ? 'border-left: 4px solid var(--accent);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                    <div style="font-size: 2rem; width: 60px; height: 60px; 
                                         display: flex; align-items: center; justify-content: center;
                                         background: ${isDiscovered ? 'var(--success-light)' : 'var(--light)'};
                                         border-radius: var(--radius-md);">
                                        ${isDiscovered ? recipe.icon : 'â“'}
                                    </div>
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 5px 0; color: var(--dark);">
                                            ${isDiscovered ? recipe.name : 'ç¥ç§˜èœè°±'}
                                        </h3>
                                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                            <div class="difficulty-badge">
                                                <span>éš¾åº¦ï¼š</span>
                                                <span class="star">${"â˜…".repeat(recipe.difficulty)}</span>
                                            </div>
                                            ${!isDiscovered && attempts > 0 ? `
                                                <span style="color: var(--gray); font-size: 0.9rem;">
                                                    å·²å°è¯• ${attempts} æ¬¡
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                                
                                ${isDiscovered ? `
                                    <div style="margin-top: 15px;">
                                        <p style="color: var(--gray); margin-bottom: 15px; font-size: 1rem;">${recipe.description}</p>
                                        
                                        <h4 style="margin-bottom: 10px; font-size: 1rem; color: var(--dark);">é…æ–¹æ­ç§˜ï¼š</h4>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            ${recipe.ingredients.map(ing => {
                                                const crop = cropsData?.find(c => c.id === ing.cropId);
                                                const currentCount = (userData.storage || {})[ing.cropId] || 0;
                                                return `
                                                    <div style="display: flex; align-items: center; gap: 8px; 
                                                         background: ${currentCount >= ing.quantity ? '#E8F5E9' : '#FFEBEE'}; 
                                                         padding: 8px 15px; border-radius: var(--radius-md);">
                                                        <span style="font-size: 1.2rem;">${crop?.icon}</span>
                                                        <div>
                                                            <div style="font-weight: 600;">${crop?.name}</div>
                                                            <div style="font-size: 0.9rem; color: ${currentCount >= ing.quantity ? 'var(--success)' : 'var(--danger)'}">
                                                                éœ€è¦ ${ing.quantity}ä¸ª
                                                            </div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div style="margin-top: 15px;">
                                        <p style="color: var(--gray); margin-bottom: 15px; font-size: 0.95rem;">
                                            <i class="fas fa-lightbulb"></i> ${recipe.hints?.[0] || 'è¿™æ˜¯ä¸€é“ç¥ç§˜çš„èœè°±ï¼Œéœ€è¦é€šè¿‡ç ”å‘æ¥è§£é”...'}
                                        </p>
                                        
                                        ${attempts > 0 ? `
                                            <div class="clue-box">
                                                <div class="clue-title">
                                                    <i class="fas fa-search"></i>
                                                    <span>å·²å‘ç°çš„çº¿ç´¢</span>
                                                </div>
                                                <p style="color: var(--dark); margin: 0;">
                                                    ${getCurrentClue(recipe, recipeHistory)}
                                                </p>
                                                ${recipeHistory.revealedClues ? `
                                                    <p class="hint-text">
                                                        çº¿ç´¢è¿›åº¦ï¼š${recipeHistory.revealedClues}/${recipe.clues?.length || 3}
                                                    </p>
                                                ` : ''}
                                            </div>
                                        ` : `
                                            <div style="background: var(--light); padding: 15px; border-radius: var(--radius-md);">
                                                <div style="color: var(--accent); margin-bottom: 10px;">
                                                    <i class="fas fa-lightbulb"></i> ç ”å‘æç¤º
                                                </div>
                                                <p style="color: var(--gray); margin: 0;">
                                                    é€‰æ‹©ä¸€ä¸ªèœè°±å¼€å§‹ç ”å‘ï¼Œç³»ç»Ÿä¼šæ ¹æ®ä½ çš„å°è¯•ç»™äºˆçº¿ç´¢
                                                </p>
                                            </div>
                                        `}
                                        
                                        <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                                            <div style="display: flex; align-items: center; gap: 5px; color: var(--gray); font-size: 0.9rem;">
                                                <i class="fas fa-clipboard-check"></i>
                                                <span>åŒ…å« ${recipe.ingredients.length} ç§ææ–™</span>
                                            </div>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        ${!isDiscovered ? `
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--light);">
                                <button class="btn btn-primary" onclick="startRecipeResearch('${recipe.id}')" 
                                        style="width: 100%; justify-content: center;">
                                    <i class="fas fa-flask"></i> å¼€å§‹ç ”å‘æ­¤èœè°±
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // è·å–å½“å‰çº¿ç´¢
        function getCurrentClue(recipe, history) {
            if (!history || history.revealedClues === 0) {
                return "å°è¯•ä¸åŒçš„ææ–™ç»„åˆæ¥å‘ç°é…æ–¹";
            }
            
            const clueIndex = Math.min(history.revealedClues - 1, (recipe.clues?.length || 1) - 1);
            return recipe.clues?.[clueIndex] || "ç»§ç»­æ¢ç´¢ï¼Œä½ ä¼šæ‰¾åˆ°ç­”æ¡ˆçš„";
        }

        // æ¸²æŸ“ç ”å‘è¿›åº¦
        function renderResearchProgress() {
            const container = document.getElementById('researchProgress');
            const discoveredCount = (userData.discoveredRecipes || []).length;
            const totalCount = recipesData?.length || 0;
            const progressPercent = totalCount > 0 ? (discoveredCount / totalCount) * 100 : 0;
            
            // è®¡ç®—æ€»å°è¯•æ¬¡æ•°
            const totalAttempts = researchHistory ? Object.values(researchHistory)
                .reduce((sum, hist) => sum + (hist.attempts || 0), 0) : 0;
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px; color: var(--primary);">
                        ${discoveredCount}/${totalCount}
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ç ”å‘è¿›åº¦</span>
                            <span>${Math.round(progressPercent)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: var(--radius-md); margin-top: 20px;">
                        <h4><i class="fas fa-chart-line"></i> ç ”å‘ç»Ÿè®¡</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div style="text-align: center; background: white; padding: 15px; border-radius: var(--radius-sm);">
                                <div style="font-size: 1.5rem; color: var(--primary); font-weight: bold;">${totalAttempts}</div>
                                <div style="font-size: 0.9rem; color: var(--gray);">æ€»å°è¯•æ¬¡æ•°</div>
                            </div>
                            <div style="text-align: center; background: white; padding: 15px; border-radius: var(--radius-sm);">
                                <div style="font-size: 1.5rem; color: var(--success); font-weight: bold;">${userData.maxHabits || 3}</div>
                                <div style="font-size: 0.9rem; color: var(--gray);">å½“å‰ä¹ æƒ¯ä½</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(0,0,0,0.1);">
                            <div style="color: var(--success); font-weight: bold;">
                                <i class="fas fa-award"></i> å¥–åŠ±ï¼šæ¯è§£é”ä¸€ä¸ªèœè°±å¢åŠ 1ä¸ªä¹ æƒ¯ä½
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // å¼€å§‹ç ”å‘èœè°±
        function startRecipeResearch(recipeId) {
            const recipe = recipesData?.find(r => r.id === recipeId);
            if (!recipe) return;
            
            selectedIngredients = [];
            currentResearchRecipe = recipe;
            
            showResearchModal(recipe);
        }

        // æ™ºèƒ½æ¨èç ”å‘
        function startRandomResearch() {
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªè§£é”ä¸”ææ–™ç›¸å¯¹å……è¶³çš„èœè°±
            const undiscoveredRecipes = recipesData?.filter(recipe => 
                !userData.discoveredRecipes.includes(recipe.id)
            ) || [];
            
            if (undiscoveredRecipes.length === 0) {
                showNotification('æ‰€æœ‰èœè°±éƒ½å·²è§£é”ï¼', 'success');
                return;
            }
            
            // è®¡ç®—æ¯ä¸ªèœè°±çš„ææ–™å……è¶³åº¦
            const recipesWithScore = undiscoveredRecipes.map(recipe => {
                let score = 0;
                recipe.ingredients.forEach(ing => {
                    const count = (userData.storage || {})[ing.cropId] || 0;
                    if (count >= ing.quantity) {
                        score += 2;
                    } else if (count > 0) {
                        score += 1;
                    }
                });
                return { recipe, score };
            });
            
            // é€‰æ‹©åˆ†æ•°æœ€é«˜çš„èœè°±
            const bestRecipe = recipesWithScore.reduce((best, current) => 
                current.score > best.score ? current : best
            );
            
            if (bestRecipe.score === 0) {
                showNotification('ææ–™ä¸è¶³ï¼Œè¯·å…ˆæ”¶è·æ›´å¤šä½œç‰©', 'warning');
                return;
            }
            
            startRecipeResearch(bestRecipe.recipe.id);
        }

        // æ˜¾ç¤ºæ‰€æœ‰ææ–™ - ä¿®å¤ç‰ˆæœ¬
        function showAllIngredients() {
            const modalHtml = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-seedling"></i> æ‰€æœ‰å¯ç”¨ææ–™</h3>
                            <button class="modal-close" onclick="closeCurrentModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px;">
                                <p style="color: var(--gray); margin-bottom: 15px;">
                                    ä»¥ä¸‹æ˜¯æ‰€æœ‰å¯ç”¨çš„ææ–™ç±»å‹ï¼Œç°è‰²ææ–™è¡¨ç¤ºåº“å­˜ä¸º0
                                </p>
                                <div class="ingredient-grid">
                                    ${cropsData?.map(crop => {
                                        const quantity = (userData.storage || {})[crop.id] || 0;
                                        return `
                                            <div class="ingredient-option ${quantity === 0 ? 'disabled' : ''}" 
                                                 style="${quantity === 0 ? 'cursor: default;' : ''}">
                                                <div class="ingredient-icon">${crop.icon}</div>
                                                <div class="ingredient-name">${crop.name}</div>
                                                <div class="ingredient-count ${quantity === 0 ? 'zero' : ''}">
                                                    ${quantity}ä¸ª
                                                </div>
                                            </div>
                                        `;
                                    }).join('') || ''}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="closeCurrentModal()">
                                ç¡®å®š
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.id = 'ingredientsModal';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }

        // æ˜¾ç¤ºç ”å‘æ¨¡æ€æ¡†
        function showResearchModal(recipe) {
            const recipeHistory = researchHistory?.[recipe.id] || {};
            const attempts = recipeHistory.attempts || 0;
            
            const modalHtml = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title"><i class="fas fa-flask"></i> ç ”å‘èœè°±</h3>
                            <button class="modal-close" onclick="closeCurrentModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">${recipe.icon}</div>
                                <h3 style="margin: 0 0 5px 0;">${recipe.name}</h3>
                                <div style="color: var(--gray);">
                                    éš¾åº¦ï¼š${"â˜…".repeat(recipe.difficulty)} | ç¬¬${attempts + 1}æ¬¡å°è¯•
                                </div>
                            </div>
                            
                            <div style="margin: 20px 0; padding: 15px; background: var(--light); border-radius: var(--radius-md);">
                                <h4 style="margin-bottom: 10px; color: var(--dark);">
                                    <i class="fas fa-lightbulb"></i> å·²çŸ¥çº¿ç´¢
                                </h4>
                                ${recipe.hints?.map((hint, index) => `
                                    <p style="color: var(--gray); margin: 8px 0; padding-left: 10px; 
                                        border-left: 3px solid ${index === 0 ? 'var(--primary)' : 'var(--accent)'};">
                                        ${hint}
                                    </p>
                                `).join('') || '<p style="color: var(--gray);">æš‚æ— çº¿ç´¢</p>'}
                            </div>
                            
                            <h4 style="margin-bottom: 15px; color: var(--dark);">
                                <i class="fas fa-seedling"></i> é€‰æ‹©ç ”å‘ææ–™
                                <span style="font-size: 0.9rem; font-weight: normal; color: var(--primary); margin-left: 10px;">
                                    å·²é€‰æ‹© ${selectedIngredients.length} ç§
                                </span>
                            </h4>
                            
                            <div id="modalIngredientGrid" class="ingredient-grid">
                                ${renderModalIngredientsContent()}
                            </div>
                            
                            <div style="margin-top: 25px;">
                                <button class="btn btn-primary" id="modalTryBtn" onclick="tryResearchModal()" 
                                        style="width: 100%; justify-content: center;" disabled>
                                    <i class="fas fa-flask"></i> å°è¯•ç ”å‘
                                </button>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button class="btn btn-outline" onclick="clearResearchSelection()" style="flex: 1;">
                                        <i class="fas fa-trash"></i> æ¸…ç©ºé€‰æ‹©
                                    </button>
                                    <button class="btn btn-outline" onclick="suggestIngredients()" style="flex: 1;">
                                        <i class="fas fa-bulb"></i> æ™ºèƒ½æç¤º
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.id = 'researchModal';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
            
            updateResearchButton();
        }

        // æ¸²æŸ“æ¨¡æ€æ¡†ä¸­çš„ææ–™é€‰æ‹©å™¨
        function renderModalIngredientsContent() {
            const storage = userData.storage || {};
            
            if (!cropsData) return '';
            
            return cropsData.map(crop => {
                const quantity = storage[crop.id] || 0;
                const isSelected = selectedIngredients.includes(crop.id);
                const isDisabled = quantity === 0;
                
                return `
                    <div class="ingredient-option ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" 
                         onclick="${isDisabled ? '' : `toggleResearchIngredient('${crop.id}')`}">
                        <div class="ingredient-icon">${crop.icon}</div>
                        <div class="ingredient-name">${crop.name}</div>
                        <div class="ingredient-count ${quantity === 0 ? 'zero' : ''}">
                            ${quantity}ä¸ª
                        </div>
                    </div>
                `;
            }).join('');
        }

        // åˆ‡æ¢ç ”å‘ææ–™
        function toggleResearchIngredient(cropId) {
            const index = selectedIngredients.indexOf(cropId);
            if (index === -1) {
                selectedIngredients.push(cropId);
            } else {
                selectedIngredients.splice(index, 1);
            }
            
            updateResearchButton();
            highlightSelectedIngredients();
        }

        // æ›´æ–°ç ”å‘æŒ‰é’®çŠ¶æ€
        function updateResearchButton() {
            const btn = document.getElementById('modalTryBtn');
            if (btn) {
                btn.disabled = selectedIngredients.length === 0;
                btn.innerHTML = `<i class="fas fa-flask"></i> å°è¯•ç ”å‘ (${selectedIngredients.length}ç§ææ–™)`;
            }
        }

        // æ™ºèƒ½æç¤ºææ–™
        function suggestIngredients() {
            if (!currentResearchRecipe) return;
            
            // æ ¹æ®åº“å­˜æ¨èå¯èƒ½çš„ææ–™ç»„åˆ
            const requiredCrops = currentResearchRecipe.ingredients.map(ing => ing.cropId);
            const storage = userData.storage || {};
            
            // é€‰æ‹©åº“å­˜å……è¶³çš„ææ–™
            selectedIngredients = requiredCrops.filter(cropId => {
                const crop = cropsData?.find(c => c.id === cropId);
                return crop && (storage[cropId] || 0) > 0;
            }).slice(0, currentResearchRecipe.ingredients.length);
            
            // æ›´æ–°æ˜¾ç¤º
            updateResearchButton();
            
            const modalGrid = document.getElementById('modalIngredientGrid');
            if (modalGrid) {
                modalGrid.innerHTML = renderModalIngredientsContent();
            }
            
            showNotification('å·²æ ¹æ®åº“å­˜æ¨èææ–™ç»„åˆ', 'success');
        }

        // å°è¯•ç ”å‘ï¼ˆæ¨¡æ€æ¡†ç‰ˆæœ¬ï¼‰
        async function tryResearchModal() {
            if (selectedIngredients.length === 0 || !currentResearchRecipe) {
                showNotification('è¯·å…ˆé€‰æ‹©ææ–™', 'warning');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/research-recipe`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        recipeId: currentResearchRecipe.id,
                        usedIngredients: selectedIngredients
                    })
                });
                
                const data = await response.json();
                closeCurrentModal();
                
                if (data.success) {
                    showRecipeReveal(data.recipe);
                } else {
                    showResearchFailed(data);
                }
                
            } catch (error) {
                console.error('ç ”å‘é”™è¯¯:', error);
                showNotification('ç ”å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ˜¾ç¤ºç ”å‘æˆåŠŸ
        function showRecipeReveal(recipe) {
            const modalHtml = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" style="color: var(--success);">
                                <i class="fas fa-award"></i> ç ”å‘æˆåŠŸï¼
                            </h3>
                        </div>
                        <div class="modal-body">
                            <div class="recipe-reveal">
                                <div class="recipe-icon-large">${recipe.icon}</div>
                                <h2 style="color: var(--success); margin-bottom: 15px;">${recipe.name}</h2>
                                <p style="color: var(--gray); font-size: 1.1rem; margin-bottom: 25px;">${recipe.description}</p>
                                
                                <div style="background: var(--light); padding: 20px; border-radius: var(--radius-md); margin-bottom: 25px;">
                                    <h4 style="margin-bottom: 15px; color: var(--dark);">é…æ–¹å·²æ­ç§˜ï¼š</h4>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                                        ${recipe.ingredients.map(ing => {
                                            const crop = cropsData?.find(c => c.id === ing.cropId);
                                            return `
                                                <div style="text-align: center; padding: 10px; background: white; border-radius: var(--radius-sm);">
                                                    <div style="font-size: 1.5rem; margin-bottom: 5px;">${crop?.icon}</div>
                                                    <div style="font-weight: 600; margin-bottom: 5px;">${crop?.name}</div>
                                                    <div style="color: var(--primary); font-weight: bold;">Ã—${ing.quantity}</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <div style="background: linear-gradient(135deg, #E8F5E9, #C8E6C9); padding: 15px; border-radius: var(--radius-md);">
                                    <h4 style="color: var(--success); margin-bottom: 10px;">
                                        <i class="fas fa-star"></i> ç ”å‘å¥–åŠ±
                                    </h4>
                                    <p style="color: var(--dark); margin: 0;">
                                        æ­å–œï¼è§£é”äº†æ–°çš„ä¹ æƒ¯ä½ï¼Œç°åœ¨å¯ä»¥æ·»åŠ æ›´å¤šä¹ æƒ¯æ¥ç§æ¤äº†ï¼
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-success" onclick="closeCurrentModal(); loadPageData();">
                                ç»§ç»­æ¢ç´¢
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.id = 'revealModal';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }

        // æ˜¾ç¤ºç ”å‘å¤±è´¥
        function showResearchFailed(data) {
            const modalHtml = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" style="color: var(--accent);">
                                <i class="fas fa-search"></i> ç»§ç»­æ¢ç´¢
                            </h3>
                        </div>
                        <div class="modal-body">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;">ğŸ”</div>
                                <p style="color: var(--gray); font-size: 1.1rem; margin-bottom: 20px;">${data.message}</p>
                            </div>
                            
                            ${data.clue ? `
                                <div class="clue-box">
                                    <div class="clue-title">
                                        <i class="fas fa-lightbulb"></i>
                                        <span>æ–°çº¿ç´¢æç¤º</span>
                                    </div>
                                    <p style="color: var(--dark); margin: 10px 0;">${data.clue}</p>
                                    ${data.hint ? `<p class="hint-text">${data.hint}</p>` : ''}
                                    ${data.attempts ? `<p class="hint-text">å½“å‰å°è¯•ï¼šç¬¬${data.attempts}æ¬¡</p>` : ''}
                                </div>
                            ` : ''}
                            
                            ${data.missing ? `
                                <div style="background: #FFEBEE; padding: 15px; border-radius: var(--radius-md); margin-top: 20px;">
                                    <h4 style="color: var(--danger); margin-bottom: 10px;">
                                        <i class="fas fa-exclamation-triangle"></i> ææ–™ä¸è¶³
                                    </h4>
                                    <ul style="color: var(--danger); padding-left: 20px; margin: 0;">
                                        ${data.missing.map(item => `<li>${item}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <div style="margin-top: 25px; padding-top: 25px; border-top: 1px solid var(--light);">
                                <h4 style="margin-bottom: 15px; color: var(--dark);">æç¤ºï¼š</h4>
                                <ul style="color: var(--gray); padding-left: 20px; margin: 0;">
                                    <li>å°è¯•ä¸åŒçš„ææ–™ç»„åˆ</li>
                                    <li>æ³¨æ„æ¯ç§ææ–™çš„åº“å­˜æ•°é‡</li>
                                    <li>å›å¿†ä¸€ä¸‹ä¹‹å‰çš„çº¿ç´¢æç¤º</li>
                                    <li>æ€»é£Ÿææ•°é‡å¯èƒ½æ˜¯å…³é”®</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="closeCurrentModal(); loadPageData();">
                                ç»§ç»­å°è¯•
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.id = 'failedModal';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }

        // æ¸…ç©ºé€‰æ‹©
        function clearResearchSelection() {
            selectedIngredients = [];
            updateResearchButton();
            
            const modalGrid = document.getElementById('modalIngredientGrid');
            if (modalGrid) {
                modalGrid.innerHTML = renderModalIngredientsContent();
            }
        }

        // å…³é—­å½“å‰æ¿€æ´»çš„æ¨¡æ€æ¡†
        function closeCurrentModal() {
            // æ‰¾åˆ°æ‰€æœ‰æ´»è·ƒçš„æ¨¡æ€æ¡†
            const activeModals = document.querySelectorAll('.modal-overlay.active');
            activeModals.forEach(modal => {
                modal.classList.remove('active');
                setTimeout(() => {
                    const modalContainer = modal.closest('div[id]');
                    if (modalContainer) {
                        modalContainer.remove();
                    }
                }, 300);
            });
        }

        // é«˜äº®é€‰ä¸­çš„ææ–™
        function highlightSelectedIngredients() {
            const modal = document.getElementById('researchModal');
            if (!modal) return;
            
            modal.querySelectorAll('.ingredient-option').forEach(option => {
                const onclickAttr = option.getAttribute('onclick');
                if (!onclickAttr) return;
                
                const match = onclickAttr.match(/['"]([^'"]+)['"]/);
                if (!match) return;
                
                const cropId = match[1];
                if (selectedIngredients.includes(cropId)) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <div>${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', loadPageData);
        
        // æ·»åŠ ç‚¹å‡»ç©ºç™½å¤„å…³é—­æ¨¡æ€æ¡†çš„æ”¯æŒ
        document.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal-overlay')) {
                closeCurrentModal();
            }
        });
        
        // ESCé”®å…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeCurrentModal();
            }
        });
    </script>
</body>
</html>