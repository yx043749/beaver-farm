<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“æ³¨å†œåœº - ä»“åº“ä¸èœè°±</title>
    <script src="common.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-scroll"></i> ä»“åº“ä¸èœè°±ç ”å‘</h1>
                    <p class="subtitle">ç®¡ç†ææ–™ï¼Œç ”å‘ç¥ç§˜èœè°±</p>
                </div>
                <div>
                    <button class="btn btn-primary btn-small" onclick="window.location.href='main.html'">
                        <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
                    </button>
                </div>
            </div>
        </header>

        <div class="grid grid-2">
            <!-- ææ–™ä»“åº“ -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-warehouse"></i> ææ–™ä»“åº“</h2>
                <p style="color: var(--gray); margin-bottom: 20px;">
                    æ”¶è·çš„ä½œç‰©ä¼šå­˜æ”¾åœ¨è¿™é‡Œï¼Œç”¨äºèœè°±ç ”å‘
                </p>
                
                <div id="storageList" class="grid grid-3">
                    <!-- ä»“åº“åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-box-open" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: var(--radius-md);">
                    <h4><i class="fas fa-lightbulb"></i> å¦‚ä½•è·å¾—ææ–™</h4>
                    <ul style="margin-top: 10px; padding-left: 20px; color: var(--gray);">
                        <li>ç§æ¤å¹¶æ”¶è·ä½œç‰©</li>
                        <li>æ¯å¤©æ‰“å¡ä¹ æƒ¯ä¿ƒè¿›ä½œç‰©ç”Ÿé•¿</li>
                        <li>ä½œç‰©æˆç†Ÿåå³å¯æ”¶è·</li>
                    </ul>
                </div>
            </div>

            <!-- ä¿®æ”¹èœè°±ç ”å‘éƒ¨åˆ† -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-flask"></i> èœè°±ç ”å‘</h2>
                <p style="color: var(--gray); margin-bottom: 20px;">
                    é€šè¿‡çº¿ç´¢æ¢ç´¢ç¥ç§˜èœè°±ï¼Œä½¿ç”¨ä»“åº“ææ–™è¿›è¡Œå°è¯•
                </p>
                
                <div id="recipesList">
                    <!-- èœè°±åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- æ·»åŠ ç ”å‘åŒºåŸŸ -->
                <div class="card" style="margin-top: 20px; background: #F8F9FA;">
                    <h3 class="card-title"><i class="fas fa-search"></i> é…æ–¹æ¢ç´¢</h3>
                    <div id="researchArea">
                        <p style="color: var(--gray); margin-bottom: 15px;">
                            é€‰æ‹©ææ–™è¿›è¡Œå°è¯•ï¼Œç³»ç»Ÿä¼šç»™å‡ºçº¿ç´¢æç¤º
                        </p>
                        
                        <div class="grid grid-3" id="researchIngredients">
                            <!-- ææ–™é€‰æ‹©å™¨ -->
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" id="tryResearchBtn" onclick="tryResearch()" disabled>
                                <i class="fas fa-flask"></i> å°è¯•ç ”å‘
                            </button>
                            <button class="btn btn-danger btn-small" onclick="clearResearch()">
                                <i class="fas fa-trash"></i> æ¸…ç©ºé€‰æ‹©
                            </button>
                        </div>
                        
                        <div id="researchResult" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç ”å‘è¿›åº¦ -->
        <div class="card">
            <h2 class="card-title"><i class="fas fa-chart-pie"></i> ç ”å‘è¿›åº¦</h2>
            <div id="researchProgress">
                <!-- ç ”å‘è¿›åº¦å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div style="text-align: center; padding: 20px; color: var(--gray);">
                    <i class="fas fa-chart-bar" style="font-size: 2rem; margin-bottom: 10px;"></i>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // åŠ¨æ€è·å–åç«¯åœ°å€
        function getApiBase() {
            // ä¼˜å…ˆä½¿ç”¨å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœº
            const currentUrl = window.location.origin;
            
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼Œä½¿ç”¨é»˜è®¤localhost
            if (currentUrl === 'file://' || currentUrl.startsWith('file://')) {
                return 'http://localhost:3000/api';
            }
            
            // å¦åˆ™ä½¿ç”¨å½“å‰åŸŸå
            return `${currentUrl}/api`;
        }

        let API_BASE = getApiBase();
        console.log('APIåœ°å€:', API_BASE);

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        const networkStatus = document.createElement('div');
        networkStatus.className = 'network-status';
        document.body.appendChild(networkStatus);

        // æ£€æŸ¥ç½‘ç»œè¿æ¥
        function checkNetworkStatus() {
            if (navigator.onLine) {
                networkStatus.textContent = 'åœ¨çº¿';
                networkStatus.className = 'network-status online';
                
                // éšè—ç½‘ç»œçŠ¶æ€æç¤º
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 2000);
            } else {
                networkStatus.textContent = 'ç¦»çº¿ - æ£€æŸ¥ç½‘ç»œè¿æ¥';
                networkStatus.className = 'network-status offline';
            }
        }

        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);

        // åˆå§‹æ£€æŸ¥
        checkNetworkStatus();

        // ä¿®æ”¹æ‰€æœ‰fetchè¯·æ±‚ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok && response.status !== 401) {
                    showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                }
                
                return response;
            } catch (error) {
                console.error('ç½‘ç»œè¯·æ±‚é”™è¯¯:', error);
                
                // æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
                let errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š<br>
                                1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (${API_BASE.replace('/api', '')})<br>
                                2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                                3. é˜²ç«å¢™è®¾ç½®`;
                } else if (error.message.includes('NetworkError')) {
                    errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                }
                
                showNotification(errorMsg, 'error');
                throw error;
            }
        };

        // const API_BASE = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('authToken');
        let userData = null;
        let cropsData = null;
        let recipesData = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!authToken) {
            window.location.href = 'index.html';
        }

        // æ¸²æŸ“ç ”å‘ææ–™é€‰æ‹©å™¨
        function renderResearchIngredients() {
            const container = document.getElementById('researchIngredients');
            const storage = userData.storage || {};
            
            if (!cropsData) return;
            
            container.innerHTML = cropsData.map(crop => {
                const quantity = storage[crop.id] || 0;
                
                return `
                    <div class="crop-option" onclick="toggleResearchIngredient('${crop.id}')" 
                        style="cursor: pointer; ${quantity === 0 ? 'opacity: 0.5;' : ''}">
                        <div style="font-size: 2rem; margin-bottom: 10px;">${crop.icon}</div>
                        <div style="font-weight: bold; margin-bottom: 5px;">${crop.name}</div>
                        <div style="color: var(--gray); font-size: 0.9rem;">
                            åº“å­˜: <span style="color: ${quantity > 0 ? 'var(--primary)' : 'var(--danger)'}; font-weight: bold;">${quantity}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        let selectedIngredients = [];

        // åˆ‡æ¢ç ”å‘ææ–™
        function toggleResearchIngredient(cropId) {
            const quantity = (userData.storage || {})[cropId] || 0;
            if (quantity === 0) return;
            
            const index = selectedIngredients.indexOf(cropId);
            if (index === -1) {
                selectedIngredients.push(cropId);
            } else {
                selectedIngredients.splice(index, 1);
            }
            
            updateResearchButton();
            highlightSelectedIngredients();
        }

        // é«˜äº®é€‰ä¸­çš„ææ–™
        function highlightSelectedIngredients() {
            document.querySelectorAll('#researchIngredients .crop-option').forEach(option => {
                const cropId = option.onclick.toString().match(/'([^']+)'/)[1];
                if (selectedIngredients.includes(cropId)) {
                    option.style.borderColor = 'var(--primary)';
                    option.style.boxShadow = '0 0 0 2px rgba(255, 158, 109, 0.3)';
                } else {
                    option.style.borderColor = '';
                    option.style.boxShadow = '';
                }
            });
        }

        // æ›´æ–°ç ”å‘æŒ‰é’®çŠ¶æ€
        function updateResearchButton() {
            const btn = document.getElementById('tryResearchBtn');
            btn.disabled = selectedIngredients.length === 0;
        }

        // å°è¯•ç ”å‘
        async function tryResearch() {
            if (selectedIngredients.length === 0) return;
            
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªè§£é”çš„èœè°±
            const undiscoveredRecipe = recipesData?.find(recipe => 
                !userData.discoveredRecipes.includes(recipe.id)
            );
            
            if (!undiscoveredRecipe) {
                showModal('æç¤º', 'æ‰€æœ‰èœè°±éƒ½å·²ç»è§£é”äº†ï¼');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/research-recipe`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        recipeId: undiscoveredRecipe.id,
                        usedIngredients: selectedIngredients
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showModal('ç ”å‘æˆåŠŸ', `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3rem; margin-bottom: 15px;">${data.recipe.icon}</div>
                            <h3 style="color: var(--success); margin-bottom: 10px;">${data.recipe.name}</h3>
                            <p style="color: var(--gray); margin-bottom: 20px;">${data.recipe.description}</p>
                            
                            <div style="background: var(--light); padding: 15px; border-radius: var(--radius-md); margin-bottom: 20px;">
                                <h4 style="margin-bottom: 10px;">æ‰€éœ€ææ–™ï¼š</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                    ${data.recipe.ingredients.map(ing => {
                                        const crop = cropsData?.find(c => c.id === ing.cropId);
                                        return `
                                            <div style="display: flex; align-items: center; gap: 5px; background: white; padding: 8px 12px; border-radius: var(--radius-sm);">
                                                <span style="font-size: 1.2rem;">${crop?.icon}</span>
                                                <span>${crop?.name} Ã—${ing.quantity}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <p style="color: var(--success); font-weight: bold;">
                                <i class="fas fa-award"></i> è§£é”æ–°èœè°±ï¼ä¹ æƒ¯ä½+1
                            </p>
                        </div>
                    `);
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadPageData();
                    
                } else {
                    // ç ”å‘å¤±è´¥ï¼Œæ˜¾ç¤ºçº¿ç´¢
                    showModal('ç ”å‘å¤±è´¥', `
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;">ğŸ”</div>
                            <h3 style="color: var(--accent); margin-bottom: 15px;">ç»§ç»­æ¢ç´¢</h3>
                            <p style="color: var(--gray); margin-bottom: 20px;">${data.message}</p>
                            
                            ${data.clue ? `
                                <div style="background: #FFF8E1; padding: 15px; border-radius: var(--radius-md); border-left: 4px solid var(--accent);">
                                    <h4 style="color: var(--accent); margin-bottom: 10px;">
                                        <i class="fas fa-lightbulb"></i> çº¿ç´¢æç¤º
                                    </h4>
                                    <p>${data.clue}</p>
                                    ${data.hint ? `<p style="margin-top: 10px; font-size: 0.9rem; color: var(--gray);">${data.hint}</p>` : ''}
                                </div>
                            ` : ''}
                            
                            <p style="margin-top: 20px; color: var(--gray); font-size: 0.9rem;">
                                å°è¯•ä¸åŒçš„ææ–™ç»„åˆï¼Œæ‰¾å‡ºæ­£ç¡®çš„é…æ–¹ï¼
                            </p>
                        </div>
                    `);
                }
                
            } catch (error) {
                console.error('ç ”å‘é”™è¯¯:', error);
                showNotification('ç ”å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ¸…ç©ºç ”å‘é€‰æ‹©
        function clearResearch() {
            selectedIngredients = [];
            updateResearchButton();
            highlightSelectedIngredients();
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†å‡½æ•°
        function showModal(title, content) {
            const modalHtml = `
                <div class="modal-overlay active">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${title}</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>
                        </div>
                    </div>
                </div>
            `;
            
            const modalContainer = document.createElement('div');
            modalContainer.id = 'customModal';
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            const modal = document.getElementById('customModal');
            if (modal) {
                modal.querySelector('.modal-overlay').classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // åŠ è½½é¡µé¢æ•°æ®
        async function loadPageData() {
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const userResponse = await fetch(`${API_BASE}/user-data`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const userResult = await userResponse.json();
                if (!userResult.success) {
                    throw new Error(userResult.error || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                }
                
                userData = userResult.data;
                
                // è·å–ä½œç‰©æ•°æ®
                const cropsResponse = await fetch(`${API_BASE}/crops`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const cropsResult = await cropsResponse.json();
                if (cropsResult.success) {
                    cropsData = cropsResult.crops;
                }
                
                // è·å–èœè°±æ•°æ®
                const recipesResponse = await fetch(`${API_BASE}/recipes`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const recipesResult = await recipesResponse.json();
                if (recipesResult.success) {
                    recipesData = recipesResult.recipes;
                }
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                renderStorageList();
                renderRecipesList();
                renderResearchProgress();
                renderResearchIngredients();
                
            } catch (error) {
                console.error('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            }
        }

        // æ¸²æŸ“ä»“åº“åˆ—è¡¨
        function renderStorageList() {
            const container = document.getElementById('storageList');
            const storage = userData.storage || {};
            
            // è¿‡æ»¤å‡ºæœ‰åº“å­˜çš„ä½œç‰©
            const items = [];
            if (cropsData) {
                cropsData.forEach(crop => {
                    const quantity = storage[crop.id] || 0;
                    if (quantity > 0) {
                        items.push({ crop, quantity });
                    }
                });
            }
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h3>ä»“åº“ç©ºç©ºå¦‚ä¹Ÿ</h3>
                        <p style="margin-top: 10px;">å¿«å»ç§æ¤ä½œç‰©å¹¶æ”¶è·å§ï¼</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" onclick="window.location.href='crops.html'">
                            <i class="fas fa-seedling"></i> å‰å¾€ç§æ¤
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="storage-item" style="text-align: center;">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">${item.crop.icon}</div>
                    <h4>${item.crop.name}</h4>
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 10px 0;">
                        ${item.quantity}ä¸ª
                    </div>
                    <div style="font-size: 0.9rem; color: var(--gray);">
                        æ”¶è·é‡: ${item.crop.harvestAmount}ä¸ª/æ¬¡
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“èœè°±åˆ—è¡¨
        function renderRecipesList() {
            const container = document.getElementById('recipesList');
            if (!recipesData) {
                container.innerHTML = '<p style="color: var(--danger);">èœè°±æ•°æ®åŠ è½½å¤±è´¥</p>';
                return;
            }
            
            const discoveredRecipes = userData.discoveredRecipes || [];
            
            container.innerHTML = recipesData.map(recipe => {
                const isDiscovered = discoveredRecipes.includes(recipe.id);
                
                // æ£€æŸ¥ææ–™æ˜¯å¦è¶³å¤Ÿ
                let canResearch = true;
                let missingIngredients = [];
                
                if (!isDiscovered) {
                    recipe.ingredients.forEach(ing => {
                        const crop = cropsData?.find(c => c.id === ing.cropId);
                        const quantity = (userData.storage || {})[ing.cropId] || 0;
                        
                        if (quantity < ing.quantity) {
                            canResearch = false;
                            missingIngredients.push(`${crop?.name} ${quantity}/${ing.quantity}`);
                        }
                    });
                }
                
                return `
                    <div class="recipe-item ${isDiscovered ? 'unlocked' : ''}" style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="font-size: 1.5rem;">${isDiscovered ? recipe.icon : 'â“'}</span>
                                    <h3 style="margin: 0;">${isDiscovered ? recipe.name : 'ç¥ç§˜èœè°±'}</h3>
                                    <span style="background: ${isDiscovered ? 'var(--success)' : 'var(--primary)'}; 
                                          color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem;">
                                        ${isDiscovered ? 'å·²è§£é”' : 'éš¾åº¦ ' + recipe.difficulty}
                                    </span>
                                </div>
                                
                                <p style="color: var(--gray); margin-bottom: 15px;">
                                    ${isDiscovered ? recipe.description : recipe.hints?.[0] || 'æœªçŸ¥çš„èœè°±ï¼Œç­‰å¾…ç ”å‘...'}
                                </p>
                                
                                ${isDiscovered ? `
                                    <div style="margin-top: 15px;">
                                        <h4 style="margin-bottom: 8px; font-size: 1rem;">æ‰€éœ€ææ–™ï¼š</h4>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            ${recipe.ingredients.map(ing => {
                                                const crop = cropsData?.find(c => c.id === ing.cropId);
                                                return `
                                                    <div style="display: flex; align-items: center; gap: 5px; 
                                                         background: var(--light); padding: 5px 10px; border-radius: var(--radius-sm);">
                                                        <span>${crop?.icon}</span>
                                                        <span>${crop?.name} Ã—${ing.quantity}</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                ` : `
                                    <div style="margin-top: 15px;">
                                        <h4 style="margin-bottom: 8px; font-size: 1rem;">ç ”å‘æ‰€éœ€ï¼š</h4>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            ${recipe.ingredients.map(ing => {
                                                const crop = cropsData?.find(c => c.id === ing.cropId);
                                                const quantity = (userData.storage || {})[ing.cropId] || 0;
                                                const hasEnough = quantity >= ing.quantity;
                                                
                                                return `
                                                    <div style="display: flex; align-items: center; gap: 5px; 
                                                         background: ${hasEnough ? '#E8F5E9' : '#FFEBEE'}; 
                                                         padding: 5px 10px; border-radius: var(--radius-sm);">
                                                        <span>${crop?.icon}</span>
                                                        <span>${crop?.name} Ã—${ing.quantity}</span>
                                                        <span style="color: ${hasEnough ? 'var(--success)' : 'var(--danger)'}; 
                                                              font-weight: bold;">(${quantity})</span>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                        
                                        ${missingIngredients.length > 0 ? `
                                            <div style="color: var(--danger); font-size: 0.9rem; margin-top: 10px;">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                ç¼ºå°‘ææ–™: ${missingIngredients.join(', ')}
                                            </div>
                                        ` : ''}
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        ${!isDiscovered && canResearch ? `
                            <div style="margin-top: 15px; text-align: center;">
                                <button class="btn btn-success" onclick="researchRecipe('${recipe.id}')">
                                    <i class="fas fa-flask"></i> å¼€å§‹ç ”å‘
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // æ¸²æŸ“ç ”å‘è¿›åº¦
        function renderResearchProgress() {
            const container = document.getElementById('researchProgress');
            const discoveredCount = (userData.discoveredRecipes || []).length;
            const totalCount = recipesData?.length || 0;
            const progressPercent = totalCount > 0 ? (discoveredCount / totalCount) * 100 : 0;
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">
                        ${discoveredCount}/${totalCount}
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ç ”å‘è¿›åº¦</span>
                            <span>${Math.round(progressPercent)}%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: var(--radius-md); margin-top: 20px;">
                        <h4><i class="fas fa-award"></i> ç ”å‘å¥–åŠ±</h4>
                        <div style="margin-top: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: var(--success);"></i>
                                <span>æ¯è§£é”ä¸€ä¸ªèœè°±ï¼Œå¢åŠ ä¸€ä¸ªä¹ æƒ¯ä½</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-seedling" style="color: var(--primary);"></i>
                                <span>å½“å‰ä¹ æƒ¯ä½: ${userData.maxHabits || 3}ä¸ª</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ç ”å‘èœè°±
        async function researchRecipe(recipeId) {
            const recipe = recipesData?.find(r => r.id === recipeId);
            if (!recipe) {
                showNotification('èœè°±ä¸å­˜åœ¨', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦ç ”å‘"${recipe.name}"å—ï¼Ÿå°†ä¼šæ¶ˆè€—æ‰€éœ€çš„ææ–™ã€‚`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/research-recipe`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        recipeId,
                        ingredients: recipe.ingredients 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`æ­å–œï¼æˆåŠŸè§£é”èœè°±ï¼š${recipe.icon} ${recipe.name}ï¼`, 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadPageData();
                } else {
                    showNotification(data.error || 'ç ”å‘å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç ”å‘èœè°±é”™è¯¯:', error);
                showNotification('ç ”å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <div>${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', loadPageData);
    </script>
</body>
</html>