<!DOCTYPE html>
<html lang="zh-CN">
<head>    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸“æ³¨å†œåœº - ä¸»é¡µé¢</title>
    <script src="common.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1><i class="fas fa-seedling"></i> ä¸“æ³¨å†œåœº</h1>
                    <p class="subtitle">æ¬¢è¿ï¼Œ<span id="username"></span>ï¼
                        <span id="loginStatus" style="font-size: 0.9rem; color: var(--gray); margin-left: 10px;"></span>
                    </p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-outline btn-small" onclick="checkLoginStatus()">
                        <i class="fas fa-info-circle"></i> ç™»å½•çŠ¶æ€
                    </button>
                    <button class="btn btn-danger btn-small" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
            
            <div class="nav-bar">
                <button class="btn btn-primary" onclick="window.location.href='main.html'">
                    <i class="fas fa-home"></i> é¦–é¡µ
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='crops.html'">
                    <i class="fas fa-seedling"></i> ä½œç‰©ç®¡ç†
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='recipes.html'">
                    <i class="fas fa-scroll"></i> ä»“åº“ä¸èœè°±
                </button>
            </div>
        </header>

        <div class="grid grid-2">
            <!-- ä¹ æƒ¯æ‰“å¡åŒºåŸŸ -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-tasks"></i> ä¹ æƒ¯æ‰“å¡</h2>
                <div id="habitsList">
                    <!-- ä¹ æƒ¯åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- ä½œç‰©ç”Ÿé•¿æƒ…å†µ -->
            <div class="card">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> ä½œç‰©ç”Ÿé•¿æƒ…å†µ</h2>
                <div id="cropDisplay">
                    <!-- ä½œç‰©ä¿¡æ¯å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div style="text-align: center; padding: 20px; color: var(--gray);">
                        <i class="fas fa-seedling" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>åŠ è½½ä¸­...</p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-success" onclick="window.location.href='crops.html'">
                        <i class="fas fa-arrow-right"></i> å‰å¾€ä½œç‰©ç®¡ç†
                    </button>
                </div>
            </div>
        </div>

        <!-- æŠ¥è¡¨åŒºåŸŸ -->
        <div class="card">
            <h2 class="card-title"><i class="fas fa-chart-bar"></i> ä¹ æƒ¯æ‰“å¡æŠ¥è¡¨</h2>
            
            <!-- ä¿®æ”¹æŠ¥è¡¨å¯¼èˆªæŒ‰é’®çš„onclick -->
            <div class="nav-bar" style="margin-bottom: 20px;">
                <button class="btn btn-small active" onclick="showReport('week', event)">å‘¨æŠ¥</button>
                <button class="btn btn-small" onclick="showReport('month', event)">æœˆæŠ¥</button>
                <button class="btn btn-small" onclick="showReport('year', event)">å¹´æŠ¥</button>
            </div>
            
            <div id="reportContent">
                <!-- æŠ¥è¡¨å†…å®¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                <div style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 20px;"></i>
                    <p>åŠ è½½æŠ¥è¡¨æ•°æ®...</p>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ•°æ® -->
        <div class="grid grid-2">
            <div class="card" style="text-align: center;">
                <h3><i class="fas fa-box"></i> æ”¶è·æ€»æ•°</h3>
                <div style="font-size: 2.5rem; font-weight: bold; color: var(--accent); margin: 15px 0;">
                    <span id="totalHarvests">0</span> ä¸ª
                </div>
            </div>
            
            <div class="card" style="text-align: center;">
                <h3><i class="fas fa-scroll"></i> èœè°±è§£é”</h3>
                <div style="font-size: 2.5rem; font-weight: bold; color: var(--secondary); margin: 15px 0;">
                    <span id="recipeCount">0</span> ä¸ª
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer"></div>

    <script>
        // åŠ¨æ€è·å–åç«¯åœ°å€
        function getApiBase() {
            // ä¼˜å…ˆä½¿ç”¨å½“å‰é¡µé¢çš„åè®®å’Œä¸»æœº
            const currentUrl = window.location.origin;
            
            // å¦‚æœæ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼Œä½¿ç”¨é»˜è®¤localhost
            if (currentUrl === 'file://' || currentUrl.startsWith('file://')) {
                return 'http://localhost:3000/api';
            }
            
            // å¦åˆ™ä½¿ç”¨å½“å‰åŸŸå
            return `${currentUrl}/api`;
        }

        let API_BASE = getApiBase();
        console.log('APIåœ°å€:', API_BASE);

        // ç½‘ç»œçŠ¶æ€æ£€æµ‹
        const networkStatus = document.createElement('div');
        networkStatus.className = 'network-status';
        document.body.appendChild(networkStatus);

        // æ£€æŸ¥ç½‘ç»œè¿æ¥
        function checkNetworkStatus() {
            if (navigator.onLine) {
                networkStatus.textContent = 'åœ¨çº¿';
                networkStatus.className = 'network-status online';
                
                // éšè—ç½‘ç»œçŠ¶æ€æç¤º
                setTimeout(() => {
                    networkStatus.style.display = 'none';
                }, 2000);
            } else {
                networkStatus.textContent = 'ç¦»çº¿ - æ£€æŸ¥ç½‘ç»œè¿æ¥';
                networkStatus.className = 'network-status offline';
            }
        }

        // ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–
        window.addEventListener('online', checkNetworkStatus);
        window.addEventListener('offline', checkNetworkStatus);

        // åˆå§‹æ£€æŸ¥
        checkNetworkStatus();

        // ä¿®æ”¹æ‰€æœ‰fetchè¯·æ±‚ï¼Œæ·»åŠ é”™è¯¯å¤„ç†
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            try {
                const response = await originalFetch.apply(this, args);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok && response.status !== 401) {
                    showNotification('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                }
                
                return response;
            } catch (error) {
                console.error('ç½‘ç»œè¯·æ±‚é”™è¯¯:', error);
                
                // æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
                let errorMsg = 'ç½‘ç»œè¿æ¥å¤±è´¥';
                
                if (error.message.includes('Failed to fetch')) {
                    errorMsg = `æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ï¼š<br>
                                1. åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨ (${API_BASE.replace('/api', '')})<br>
                                2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                                3. é˜²ç«å¢™è®¾ç½®`;
                } else if (error.message.includes('NetworkError')) {
                    errorMsg = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥';
                }
                
                showNotification(errorMsg, 'error');
                throw error;
            }
        };

        // const API_BASE = 'http://localhost:3000/api';
        let authToken = localStorage.getItem('authToken');
        let userData = null;
        let cropsData = null;
        let currentReportType = 'week';

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!authToken) {
            window.location.href = 'index.html';
        }

        // åŠ è½½é¡µé¢æ•°æ®
        async function loadPageData() {
            try {
                // è·å–ç”¨æˆ·æ•°æ®
                const userResponse = await fetch(`${API_BASE}/user-data`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const userResult = await userResponse.json();
                if (!userResult.success) {
                    throw new Error(userResult.error || 'è·å–ç”¨æˆ·æ•°æ®å¤±è´¥');
                }
                
                userData = userResult.data;
                document.getElementById('username').textContent = userData.username;

                // è·å–ä½œç‰©æ•°æ®
                const cropsResponse = await fetch(`${API_BASE}/crops`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const cropsResult = await cropsResponse.json();
                if (cropsResult.success) {
                    cropsData = cropsResult.crops;
                }
                
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                updateUserStats();
                renderHabitsList();
                renderCropDisplay();
                showReport();
            } catch (error) {
                console.error('åŠ è½½é¡µé¢æ•°æ®å¤±è´¥:', error);
                showNotification('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
            }
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆå¸¦ç‰¹æ•ˆå¼¹çª—ï¼‰
        async function checkLoginStatus() {
            try {
                const response = await fetch(`${API_BASE}/last-login`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    const lastLogin = new Date(data.lastLogin);
                    const now = new Date();
                    const daysDiff = Math.floor((now - lastLogin) / (1000 * 60 * 60 * 24));
                    const remainingDays = 30 - daysDiff;
                    const progressPercent = (remainingDays / 30) * 100;
                    
                    // åˆ›å»ºå¼¹çª—
                    const modal = document.createElement('div');
                    modal.className = 'status-modal';
                    modal.innerHTML = `
                        <div class="status-modal-backdrop" onclick="closeStatusModal()"></div>
                        <div class="status-modal-content">
                            <div class="status-modal-header">
                                <h3><i class="fas fa-user-circle"></i> è´¦æˆ·çŠ¶æ€</h3>
                                <p>æŸ¥çœ‹æ‚¨çš„ç™»å½•ä¿¡æ¯å’Œè´¦æˆ·è¯¦æƒ…</p>
                            </div>
                            
                            <div class="status-modal-body">
                                <div class="status-info-grid">
                                    <div class="status-info-item">
                                        <div class="status-info-icon">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="status-info-content">
                                            <div class="status-info-label">ç”¨æˆ·å</div>
                                            <div class="status-info-value">${userData.username}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="status-info-item">
                                        <div class="status-info-icon">
                                            <i class="fas fa-sign-in-alt"></i>
                                        </div>
                                        <div class="status-info-content">
                                            <div class="status-info-label">æœ€åç™»å½•</div>
                                            <div class="status-info-value">${lastLogin.toLocaleString()}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="status-info-item">
                                        <div class="status-info-icon">
                                            <i class="fas fa-calendar-day"></i>
                                        </div>
                                        <div class="status-info-content">
                                            <div class="status-info-label">å·²ç™»å½•å¤©æ•°</div>
                                            <div class="status-info-value ${daysDiff < 7 ? 'text-warning' : 'text-success'}">
                                                ${daysDiff}å¤©
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="status-info-item">
                                        <div class="status-info-icon">
                                            <i class="fas fa-hourglass-half"></i>
                                        </div>
                                        <div class="status-info-content">
                                            <div class="status-info-label">å‰©ä½™æœ‰æ•ˆæœŸ</div>
                                            <div class="status-info-value ${
                                                remainingDays <= 3 ? 'text-danger' : 
                                                remainingDays <= 7 ? 'text-warning' : 
                                                'text-success'
                                            }">
                                                ${remainingDays}å¤©
                                                ${remainingDays <= 3 ? '<i class="fas fa-exclamation-circle ml-2"></i>' : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="status-info-item">
                                        <div class="status-info-icon">
                                            <i class="fas fa-calendar-plus"></i>
                                        </div>
                                        <div class="status-info-content">
                                            <div class="status-info-label">è´¦å·åˆ›å»º</div>
                                            <div class="status-info-value">${new Date(data.createdAt).toLocaleDateString()}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="status-progress">
                                    <div class="status-progress-label">
                                        <span>è´¦æˆ·æœ‰æ•ˆæœŸè¿›åº¦</span>
                                        <span>${remainingDays}/30å¤©</span>
                                    </div>
                                    <div class="status-progress-bar">
                                        <div class="status-progress-fill" style="width: ${progressPercent}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="status-modal-footer">
                                <button class="status-close-btn" onclick="closeStatusModal()">
                                    <i class="fas fa-check"></i> æˆ‘çŸ¥é“äº†
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // æ˜¾ç¤ºå¼¹çª—ï¼ˆæ·»åŠ åŠ¨ç”»ï¼‰
                    setTimeout(() => {
                        modal.classList.add('active');
                        // å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
                        const progressFill = modal.querySelector('.status-progress-fill');
                        progressFill.style.width = `${progressPercent}%`;
                    }, 10);
                    
                    // æ·»åŠ ESCé”®å…³é—­æ”¯æŒ
                    modal._closeHandler = (e) => {
                        if (e.key === 'Escape') closeStatusModal();
                    };
                    document.addEventListener('keydown', modal._closeHandler);
                }
            } catch (error) {
                console.error('è·å–ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                // å³ä½¿APIå¤±è´¥ä¹Ÿæ˜¾ç¤ºåŸºæœ¬å¼¹çª—
                showSimpleStatusModal();
            }
        }

        // å…³é—­çŠ¶æ€å¼¹çª—
        function closeStatusModal() {
            const modal = document.querySelector('.status-modal');
            if (modal) {
                // ç§»é™¤é”®ç›˜äº‹ä»¶ç›‘å¬
                if (modal._closeHandler) {
                    document.removeEventListener('keydown', modal._closeHandler);
                }
                
                // å…³é—­åŠ¨ç”»
                modal.classList.remove('active');
                setTimeout(() => modal.remove(), 300);
            }
        }

        // å¦‚æœAPIå¤±è´¥ï¼Œæ˜¾ç¤ºç®€å•å¼¹çª—
        function showSimpleStatusModal() {
            const modal = document.createElement('div');
            modal.className = 'status-modal';
            modal.innerHTML = `
                <div class="status-modal-backdrop" onclick="closeStatusModal()"></div>
                <div class="status-modal-content">
                    <div class="status-modal-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> è´¦æˆ·ä¿¡æ¯</h3>
                        <p>æ— æ³•è·å–å®Œæ•´çŠ¶æ€</p>
                    </div>
                    
                    <div class="status-modal-body">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-user-circle" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
                            <p style="font-size: 1.2rem; font-weight: 600; margin-bottom: 5px;">${userData.username}</p>
                            <p style="color: var(--gray);">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨è·å–å®Œæ•´ä¿¡æ¯</p>
                        </div>
                    </div>
                    
                    <div class="status-modal-footer">
                        <button class="status-close-btn" onclick="closeStatusModal()">
                            <i class="fas fa-times"></i> å…³é—­
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                modal.classList.add('active');
            }, 10);
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE}/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    showNotification('é€€å‡ºç™»å½•æˆåŠŸ', 'success');
                    
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('rememberMe');
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                }
            } catch (error) {
                console.error('é€€å‡ºé”™è¯¯:', error);
                // å³ä½¿APIè°ƒç”¨å¤±è´¥ï¼Œä¹Ÿæ¸…é™¤æœ¬åœ°token
                localStorage.removeItem('authToken');
                localStorage.removeItem('rememberMe');
                window.location.href = 'index.html';
            }
        }

        // åœ¨loadPageDataå‡½æ•°ä¸­æ·»åŠ ç™»å½•çŠ¶æ€æ˜¾ç¤º
        function updateLoginStatus() {
            if (userData && userData.lastLogin) {
                const lastLogin = new Date(userData.lastLogin);
                const now = new Date();
                const daysDiff = Math.floor((now - lastLogin) / (1000 * 60 * 60 * 24));
                const remainingDays = 30 - daysDiff;
                
                let statusText = `å·²ç™»å½•${daysDiff}å¤©`;
                let statusColor = 'var(--success)';
                
                if (remainingDays <= 7) {
                    statusText += ` (å‰©ä½™${remainingDays}å¤©)`;
                    statusColor = 'var(--accent)';
                }
                if (remainingDays <= 3) {
                    statusColor = 'var(--danger)';
                }
                
                document.getElementById('loginStatus').innerHTML = 
                    `<span style="color: ${statusColor}">${statusText}</span>`;
            }
        }

        // åœ¨loadPageDataæˆåŠŸåŠ è½½ç”¨æˆ·æ•°æ®åè°ƒç”¨
        // åœ¨ userData = userResult.data; ä¹‹åæ·»åŠ ï¼š
        updateLoginStatus();

        // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
        function updateUserStats() {
            // åªæ›´æ–°HTMLä¸­å­˜åœ¨çš„å…ƒç´ 
            if (document.getElementById('totalHarvests')) {
                document.getElementById('totalHarvests').textContent = userData.totalHarvests || 0;
            }
            
            if (document.getElementById('recipeCount')) {
                document.getElementById('recipeCount').textContent = userData.discoveredRecipes?.length || 0;
            }
            
            // å¯é€‰ï¼šåœ¨æ§åˆ¶å°æ˜¾ç¤ºå…¶ä»–ç»Ÿè®¡ä¿¡æ¯
            console.log('ç”¨æˆ·ç»Ÿè®¡:', {
                streakDays: userData.habitStreak || 0,
                totalHarvests: userData.totalHarvests || 0,
                recipeCount: userData.discoveredRecipes?.length || 0,
                currentHabits: userData.habits?.length || 0,
                maxHabits: userData.maxHabits || 3,
                totalCompletions: userData.habits?.reduce((sum, habit) => sum + (habit.totalCompletions || 0), 0) || 0
            });
        }

        // æ¸²æŸ“ä¹ æƒ¯åˆ—è¡¨
        function renderHabitsList() {
            const container = document.getElementById('habitsList');
            const habits = userData.habits || [];
            
            if (habits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <i class="fas fa-tasks" style="font-size: 2.5rem; margin-bottom: 15px;"></i>
                        <p>è¿˜æ²¡æœ‰ä»»ä½•ä¹ æƒ¯</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">ç‚¹å‡»"æ·»åŠ æ–°ä¹ æƒ¯"æŒ‰é’®å¼€å§‹å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            habits.forEach(habit => {
                const lastCompleted = habit.lastCompleted ? new Date(habit.lastCompleted).toLocaleDateString() : 'ä»æœª';
                const today = new Date().toDateString();
                const lastCompletedDate = habit.lastCompleted ? new Date(habit.lastCompleted).toDateString() : null;
                const canCheckin = lastCompletedDate !== today;
                
                html += `
                    <div class="habit-item" style="margin-bottom: 15px;">
                        <div class="habit-info">
                            <h4>${habit.name}</h4>
                            <div class="habit-stats">
                                <span><i class="fas fa-fire"></i> è¿ç»­${habit.streak || 0}å¤©</span>
                                <span><i class="fas fa-check-circle"></i> å®Œæˆ${habit.totalCompletions || 0}æ¬¡</span>
                                <span><i class="fas fa-calendar"></i> ä¸Šæ¬¡: ${lastCompleted}</span>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-success btn-small" onclick="checkinHabit('${habit.id}')" ${!canCheckin ? 'disabled' : ''}>
                                ${canCheckin ? '<i class="fas fa-check"></i> æ‰“å¡' : '<i class="fas fa-check-double"></i> å·²æ‰“å¡'}
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // æ¸²æŸ“ä½œç‰©æ˜¾ç¤º
        function renderCropDisplay() {
            const container = document.getElementById('cropDisplay');
            const currentCrop = userData.crops?.[0];
            
            if (!currentCrop || currentCrop.harvested) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px;">
                        <div class="crop-icon">ğŸŒ±</div>
                        <h3>å½“å‰æ²¡æœ‰ä½œç‰©åœ¨ç§æ¤</h3>
                        <p style="color: var(--gray); margin: 15px 0;">å¿«å»ä½œç‰©ç®¡ç†é¡µé¢é€‰æ‹©ä½œç‰©å¼€å§‹ç§æ¤å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            const cropInfo = cropsData?.find(c => c.id === currentCrop.id);
            if (!cropInfo) {
                container.innerHTML = `<p style="color: var(--danger);">ä½œç‰©æ•°æ®åŠ è½½å¤±è´¥</p>`;
                return;
            }
            
            const progressPercent = (currentCrop.currentGrowth / cropInfo.growthTime) * 100;
            const remainingDays = Math.max(0, cropInfo.growthTime - currentCrop.currentGrowth);
            
            container.innerHTML = `
                <div style="text-align: center;">
                    <div class="crop-icon">${cropInfo.icon}</div>
                    <h3>${cropInfo.name}</h3>
                    <p style="color: var(--gray); margin-bottom: 20px;">${cropInfo.description}</p>
                    
                    <div class="crop-progress">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ç”Ÿé•¿è¿›åº¦</span>
                            <span>${currentCrop.currentGrowth}/${cropInfo.growthTime}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: var(--light); border-radius: var(--radius-md);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--gray);">è¿˜éœ€ç…§æ–™</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">${remainingDays}æ¬¡</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--gray);">é¢„è®¡æ”¶è·</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">${cropInfo.harvestAmount}ä¸ª</div>
                            </div>
                        </div>
                    </div>
                    
                    ${currentCrop.currentGrowth >= cropInfo.growthTime ? 
                        '<div style="margin-top: 20px; padding: 10px; background: var(--success); color: white; border-radius: var(--radius-md);">ä½œç‰©å·²æˆç†Ÿï¼Œå¯ä»¥æ”¶è·äº†ï¼</div>' : 
                        `<div style="margin-top: 20px; color: var(--gray); font-size: 0.9rem;">
                            ç»§ç»­æ‰“å¡ä¹ æƒ¯æ¥ä¿ƒè¿›ä½œç‰©ç”Ÿé•¿
                        </div>`
                    }
                </div>
            `;
        }

        function showReport(type, event = null) {
            currentReportType = type;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            if (event) {
                document.querySelectorAll('.nav-bar .btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
            
            const container = document.getElementById('reportContent');
            const habits = userData.habits || [];
            
            if (habits.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-chart-line" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <p>è¿˜æ²¡æœ‰ä¹ æƒ¯æ•°æ®</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">æ·»åŠ ä¹ æƒ¯å¹¶å¼€å§‹æ‰“å¡åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºç»Ÿè®¡å›¾è¡¨</p>
                    </div>
                `;
                return;
            }
            
            // è®¡ç®—å®é™…æ•°æ®
            let labels = [];
            let data = [];
            let title = '';
            
            // è·å–å½“å‰æ—¥æœŸ
            const now = new Date();
            
            switch(type) {
                case 'week':
                    // æœ¬å‘¨æ•°æ®
                    labels = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
                    data = [0, 0, 0, 0, 0, 0, 0];
                    title = 'æœ¬å‘¨æ‰“å¡æƒ…å†µ';
                    
                    // è®¡ç®—æœ¬å‘¨æ¯å¤©çš„æ€»æ‰“å¡æ¬¡æ•°
                    habits.forEach(habit => {
                        if (habit.lastCompleted) {
                            const lastDate = new Date(habit.lastCompleted);
                            const dayOfWeek = lastDate.getDay(); // 0=å‘¨æ—¥, 1=å‘¨ä¸€...
                            
                            // å¦‚æœæ˜¯æœ¬å‘¨çš„æ‰“å¡
                            const weekStart = new Date(now);
                            weekStart.setDate(now.getDate() - now.getDay() + 1); // æœ¬å‘¨ä¸€
                            weekStart.setHours(0, 0, 0, 0);
                            
                            if (lastDate >= weekStart) {
                                // è°ƒæ•´ç´¢å¼•ï¼šå‘¨ä¸€=0, å‘¨äºŒ=1, ..., å‘¨æ—¥=6
                                const adjustedIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                                data[adjustedIndex] += 1;
                            }
                        }
                    });
                    break;
                    
                case 'month':
                    // æœ¬æœˆæ•°æ®ï¼ˆæŒ‰å‘¨åˆ†ç»„ï¼‰
                    labels = ['ç¬¬1å‘¨', 'ç¬¬2å‘¨', 'ç¬¬3å‘¨', 'ç¬¬4å‘¨'];
                    data = [0, 0, 0, 0];
                    title = 'æœ¬æœˆæ‰“å¡æƒ…å†µ';
                    
                    habits.forEach(habit => {
                        if (habit.lastCompleted) {
                            const lastDate = new Date(habit.lastCompleted);
                            
                            // å¦‚æœæ˜¯æœ¬æœˆçš„æ‰“å¡
                            if (lastDate.getMonth() === now.getMonth() && 
                                lastDate.getFullYear() === now.getFullYear()) {
                                
                                const weekOfMonth = Math.floor((lastDate.getDate() - 1) / 7);
                                if (weekOfMonth >= 0 && weekOfMonth < 4) {
                                    data[weekOfMonth] += 1;
                                }
                            }
                        }
                    });
                    break;
                    
                case 'year':
                    // æœ¬å¹´æ•°æ®ï¼ˆæŒ‰æœˆåˆ†ç»„ï¼‰
                    labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                            '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                    data = new Array(12).fill(0);
                    title = 'æœ¬å¹´æ‰“å¡æƒ…å†µ';
                    
                    habits.forEach(habit => {
                        if (habit.totalCompletions && habit.createdAt) {
                            const createdDate = new Date(habit.createdAt);
                            
                            // å¦‚æœæ˜¯æœ¬å¹´åº¦åˆ›å»ºçš„ä¹ æƒ¯
                            if (createdDate.getFullYear() === now.getFullYear()) {
                                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥ç»Ÿè®¡æ¯æœˆçš„æ‰“å¡æ¬¡æ•°
                                // ç”±äºæ²¡æœ‰å­˜å‚¨è¯¦ç»†çš„æ‰“å¡å†å²ï¼Œè¿™é‡Œä½¿ç”¨ä¹ æƒ¯åˆ›å»ºæœˆçš„æ•°æ®
                                const month = createdDate.getMonth();
                                data[month] += habit.totalCompletions || 0;
                            }
                        }
                    });
                    break;
            }
            
            const maxValue = Math.max(...data, 1); // è‡³å°‘ä¸º1ï¼Œé¿å…é™¤é›¶
            
            container.innerHTML = `
                <h3 style="text-align: center; margin-bottom: 20px; color: var(--dark);">${title}</h3>
                <div class="report-chart">
                    ${data.map((value, index) => `
                        <div style="display: flex; flex-direction: column; align-items: center; height: 100%;">
                            <div class="chart-bar" style="height: ${(value / maxValue) * 100}%;" 
                                title="${labels[index]}: ${value}æ¬¡æ‰“å¡">
                                ${value > 0 ? `<div style="position: absolute; top: -25px; color: var(--primary); font-weight: bold;">${value}</div>` : ''}
                            </div>
                            <div class="chart-label">${labels[index]}</div>
                        </div>
                    `).join('')}
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <div style="display: inline-flex; align-items: center; gap: 15px; background: var(--light); padding: 10px 20px; border-radius: var(--radius-md);">
                        <div>
                            <div style="font-size: 0.9rem; color: var(--gray);">æ€»æ‰“å¡</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary);">
                                ${data.reduce((a, b) => a + b, 0)}æ¬¡
                            </div>
                        </div>
                        <div style="width: 1px; height: 30px; background: #ddd;"></div>
                        <div>
                            <div style="font-size: 0.9rem; color: var(--gray);">æ—¥å‡</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--success);">
                                ${(data.reduce((a, b) => a + b, 0) / data.length).toFixed(1)}æ¬¡
                            </div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center; color: var(--gray); font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> æ•°æ®åŸºäºä½ çš„ä¹ æƒ¯æ‰“å¡è®°å½•
                </div>
            `;
        }

        // æ‰“å¡ä¹ æƒ¯
        async function checkinHabit(habitId) {
            try {
                const response = await fetch(`${API_BASE}/checkin-habit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ habitId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä¹ æƒ¯æ‰“å¡æˆåŠŸï¼', 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    const userResponse = await fetch(`${API_BASE}/user-data`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const userResult = await userResponse.json();
                    if (userResult.success) {
                        userData = userResult.data;
                        updateUserStats();
                        renderHabitsList();
                        renderCropDisplay();
                    }
                } else {
                    showNotification(data.error || 'æ‰“å¡å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ‰“å¡é”™è¯¯:', error);
                showNotification('æ‰“å¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // æ·»åŠ æ–°ä¹ æƒ¯
        async function addNewHabit() {
            const habitName = prompt('è¯·è¾“å…¥æ–°ä¹ æƒ¯çš„åç§°ï¼š');
            if (!habitName || habitName.trim() === '') return;
            
            try {
                const response = await fetch(`${API_BASE}/add-habit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ habitName: habitName.trim() })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('ä¹ æƒ¯æ·»åŠ æˆåŠŸï¼', 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    const userResponse = await fetch(`${API_BASE}/user-data`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    const userResult = await userResponse.json();
                    if (userResult.success) {
                        userData = userResult.data;
                        updateUserStats();
                        renderHabitsList();
                    }
                } else {
                    showNotification(data.error || 'æ·»åŠ å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ ä¹ æƒ¯é”™è¯¯:', error);
                showNotification('æ·»åŠ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('authToken');
            window.location.href = 'index.html';
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <div>${message}</div>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            loadPageData().then(() => {
                // æ•°æ®åŠ è½½å®Œæˆåæ˜¾ç¤ºå‘¨æŠ¥
                showReport('week');
            });
        });
    </script>
</body>
</html>